<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Owl Tower Console (Advanced ToDo)</title>

  <!-- Pangolin 字体 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link 
    href="https://fonts.googleapis.com/css2?family=Pangolin&display=swap" 
    rel="stylesheet"
  >

  <!-- particles.js -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <style>
    /* ====== Reset & Global ====== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      display: flex; min-height: 100vh;
      font-family: 'Pangolin', cursive;
      font-size: 18px; line-height: 1.6; color: #4d3b2f;
      position: relative; overflow-x: hidden;
    }
    #particles-js {
      position: fixed; width: 100%; height: 100%;
      top: 0; left: 0; z-index: -1;
      background: #f6f2e7;
    }

    a {
      text-decoration: none; color: inherit; transition: color 0.3s;
    }
    a:hover { color: #b38b14; }

    /* ====== Sidebar ====== */
    .sidebar {
      width: 220px; background: #3d3c2e; padding: 2rem 1rem;
      position: fixed; top: 0; bottom: 0; left: 0;
      display: flex; flex-direction: column;
      z-index: 10;
    }
    .sidebar .title {
      font-size: 2rem; margin-bottom: 2rem;
      color: #fce6c9; text-align: center;
    }
    .nav-links { list-style: none; font-size: 1.25rem; }
    .nav-links li { margin-bottom: 1.2rem; }
    .nav-links li a {
      color: #fce6c9; font-weight: bold;
      padding: 0.4rem 0.6rem; border-radius: 6px;
      display: inline-block;
      transition: background 0.3s, color 0.3s;
    }
    .nav-links li a:hover {
      background: #b38b14; color: #fff;
    }
    .active { background: #b38b14; color: #fff; }

    /* ====== Main Content ====== */
    .main-content {
      margin-left: 220px; flex: 1; padding: 2rem;
      position: relative; z-index: 10;
    }
    .header-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1rem;
    }
    .header-title {
      font-size: 2rem; color: #b38b14;
    }

    /* ====== BoomBoom's typed bar ====== */
    .boom-bar {
      background: #fff8e1; 
      border: 2px dashed #b38b14; 
      border-radius: 10px;
      padding: 1rem; margin-bottom: 1rem;
      display: flex; align-items: center; gap: 1rem;
    }
    .boom-avatar {
      width: 60px; height: 60px;
      border-radius: 50%; background: #fff3c1; overflow: hidden;
      flex-shrink: 0;
    }
    .boom-avatar img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .boom-text { flex: 1; }
    .boom-text h2 {
      font-size: 1.4rem; color: #8c6e0c;
      margin-bottom: 0.25rem;
    }
    .typed-line {
      color: #6b4b0c; font-size:1rem; white-space: pre-wrap;
    }

    /* ====== Backend Nav Buttons ====== */
    .backend-nav {
      display: flex; gap: 1rem; margin-bottom: 1rem;
    }
    .backend-nav button {
      background: #8b6d0c; color: #fff; border: none; border-radius:6px;
      padding: 0.5rem 1rem; cursor: pointer;
    }
    .backend-nav button:hover { background: #b38b14; }

    /* ====== Expandable Card (ToDo) ====== */
    .expandable-card {
      background: #fffef6;
      border: 2px dashed #d0bb8c;
      border-radius: 10px;
      margin-bottom:1rem;
      overflow: hidden;
      transition: max-height 0.5s, padding 0.5s;
    }
    .expandable-card h2 {
      font-size:1.3rem; color:#5c4b12; margin:0;
      padding:1rem; cursor: pointer;
      display:flex; align-items:center; justify-content:space-between;
    }
    .expandable-card h2:hover { background:#fff4c2; }
    .expandable-card .content {
      padding:0 1rem; max-height:0; overflow:hidden;
    }
    .expandable-card.expanded .content {
      max-height:2000px; padding-bottom:1rem;
    }
    .arrow {
      font-size:1.2rem; transition: transform 0.3s;
    }
    .expanded .arrow { transform: rotate(90deg); }

    /* ====== ToDo Area ====== */
    .recommendation {
      margin: 0.5rem 0; padding: 0.4rem;
      border-left:4px solid #f77;
      background:#fffaea;
    }
    .progress-bar-container {
      margin-top:1rem; background:#eee; border-radius:6px; overflow:hidden;
      height:18px; width:80%; max-width:400px;
    }
    .progress-bar {
      height:100%; background:#b38b14; width:0%; transition:width 0.4s;
    }
    .task-category { margin-bottom:1rem; }
    .task-category h3 {
      margin-bottom:0.5rem; color:#b38b14; font-size:1.1rem;
    }
    .task-category ul { list-style:none; margin-left:1rem; padding-left:0; }
    .task-item {
      display:flex; align-items:center; margin-bottom:0.5rem; gap:0.5rem;
    }
    .task-item span.task-text { flex:1; }
    .task-item button {
      background:#d8c593; border:none; border-radius:4px;
      padding:0.3rem 0.5rem; cursor:pointer; color:#4d3b2f; font-size:0.9rem;
    }
    .task-item button:hover { background:#b9a377; }
    .highlight-warning {
      background:#ffe5e5;
      padding:0.2rem 0.4rem; border-radius:4px; margin-left:0.5rem;
      color:#c30;
    }
    .overdue { background:#ffe5e5; padding:0.2rem 0.4rem; color:#c30; }

    /* 表单 */
    .add-task-form {
      margin-top:1rem; display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;
    }
    .add-task-form input[type="text"],
    .add-task-form input[type="date"] {
      padding:0.4rem; border:1px solid #ccc; border-radius:6px;
    }
    .add-task-form select {
      padding:0.4rem; border:1px solid #ccc; border-radius:6px;
    }
    .add-task-form button {
      background:#8b6d0c; color:#fff; border:none;
      padding:0.5rem 1rem; border-radius:6px; cursor:pointer;
    }
    .add-task-form button:hover { background:#b38b14; }

    /* 子任务列表 */
    .subtask-list { margin:0.4rem 0 0.4rem 2rem; list-style:"- "; }
    .subtask-item { display:flex; align-items:center; gap:0.4rem; margin-bottom:0.2rem; }
    .subtask-item input[type="checkbox"] { transform:scale(1.1); }
    .subtask-item span { flex:1; }

    /* 补登 / 排序 / Stats */
    .rewind-section, .sorting-section, .stats-section {
      margin-top:0.6rem;
      display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;
    }
    .rewind-section input[type="date"] {
      padding:0.3rem; border:1px solid #ccc; border-radius:6px;
    }
    .rewind-section button, .sorting-section button {
      background:#8b6d0c; color:#fff; border:none; border-radius:6px;
      padding:0.4rem 0.8rem; cursor:pointer;
    }
    .rewind-section button:hover, .sorting-section button:hover {
      background:#b38b14;
    }
    .sorting-section select {
      padding:0.3rem; border:1px solid #ccc; border-radius:6px;
    }
    .stats-section p { margin:0; }

    /* Emoji Password Overlay */
    .login-overlay {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5);
      display:flex; justify-content:center; align-items:center;
      z-index:999;
    }
    .login-box {
      background:#fffef6; border:2px dashed #d0bb8c; border-radius:10px;
      width:360px; padding:1rem; text-align:center; position:relative;
    }
    .login-box h3 {
      margin-bottom:0.5rem; color:#5c4b12; font-size:1.4rem;
    }
    .emoji-sequence {
      display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap;
      font-size:1.8rem; user-select:none; margin-top:1rem;
    }
    .emoji-sequence span {
      cursor:pointer; padding:0.2rem; transition:transform 0.2s;
    }
    .emoji-sequence span:hover { transform:scale(1.2); }

    @media(max-width:768px){
      .sidebar { width:180px; }
      .main-content { margin-left:180px; }
      .login-box { width:280px; }
      .emoji-sequence { font-size:1.6rem; }
    }
  </style>
</head>
<body>

  <!-- 粒子背景 -->
  <div id="particles-js"></div>

  <!-- 侧边栏 -->
  <aside class="sidebar">
    <div class="title">Wizard Navigation</div>
    <ul class="nav-links">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="#">Badge Room</a></li>
      <li><a href="#">To Do List</a></li>
      <li><a href="#">Wish & Mood</a></li>
      <li><a href="#">Destiny Room</a></li>
      <li><a href="owltower.html" class="active">Owl Tower</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="header-row">
      <h1 class="header-title">Boom Boom’s Owl Tower Console (Advanced ToDo)</h1>
    </div>

    <!-- BoomBoom typed line -->
    <div class="boom-bar">
      <div class="boom-avatar">
        <img src="assets/images/owl-hi.png" alt="Professor Boom Boom" />
      </div>
      <div class="boom-text">
        <h2>Welcome to Advanced ToDo!</h2>
        <div class="typed-line" id="boomLine"></div>
      </div>
    </div>

    <!-- 后台导航按钮 -->
    <div class="backend-nav">
      <button>Tasks & ToDos</button>
      <button>Badge & Fragments</button>
      <button>Wish & Mood</button>
      <button>Destiny Summer</button>
      <button>Time Rewind</button>
    </div>

    <!-- 可折叠卡片: ToDo -->
    <div class="expandable-card" id="todoCard">
      <h2>
        To-Do List Editor
        <span class="arrow">▶</span>
      </h2>
      <div class="content">
        <div class="recommendation" id="recommendationBar" style="display:none;">
          <strong>Low mood detected!</strong> Suggest easier tasks / fewer pushes.
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="taskProgress"></div>
        </div>

        <div class="sorting-section">
          <label>Sort by:</label>
          <select id="sortSelect">
            <option value="none">None</option>
            <option value="deadline">Deadline</option>
            <option value="done">Done</option>
            <option value="priority">Priority</option>
          </select>
          <button id="btnSort">Sort</button>

          <button id="simulateDayBtn" title="Simulate passing day (for consecutive check)">
            +1 Day
          </button>
        </div>

        <div class="stats-section" id="statsSec" style="margin-top:0.5rem;">
          <p id="statsInfo"></p>
        </div>

        <div class="task-category">
          <h3>📌 Mandatory Tasks</h3>
          <ul id="mandatoryList"></ul>
        </div>
        <div class="task-category">
          <h3>🎯 Optional Tasks</h3>
          <ul id="optionalList"></ul>
        </div>

        <!-- Add New Task -->
        <form class="add-task-form" id="addTaskForm">
          <input type="text" id="inputText" placeholder="Task Title" />
          <input type="date" id="inputDeadline" />
          <input type="text" id="inputTags" placeholder="Tags (comma separated)" />
          <select id="inputPriority">
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="low">Low</option>
          </select>
          <select id="inputType">
            <option value="mandatory">Mandatory</option>
            <option value="optional">Optional</option>
          </select>
          <label><input type="checkbox" id="hasSubtasks" /> Subtasks?</label>
          <button type="submit">Add Task</button>
        </form>

        <!-- Export CSV -->
        <button id="exportCsvBtn" style="margin-top:1rem;">Export CSV</button>

        <!-- Time Rewind / 补登 -->
        <div class="rewind-section">
          <label>Time Rewind:</label>
          <input type="date" id="rewindDate" />
          <input type="text" id="rewindDesc" placeholder="Rewind notes" />
          <button id="rewindBtn">Backfill</button>
        </div>
      </div>
    </div>
  </main>

  <!-- 登录遮罩: 第6个emoji正确 -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h3>Emoji Magic Lock</h3>
      <div class="emoji-sequence" id="emojiSequence">
        <!-- 10 emojis randomly -->
      </div>
    </div>
  </div>

  <script>
    // 1. Particles
    particlesJS("particles-js", {
      "particles": {
        "number":{"value":50,"density":{"enable":true,"value_area":800}},
        "color":{"value":["#FFFBE6","#FFD700","#FFECB3"]},
        "shape":{"type":"star","stroke":{"width":0,"color":"#ffffff"}},
        "opacity":{"value":0.8,"random":true},
        "size":{"value":6,"random":true},
        "line_linked":{"enable":false},
        "move":{
          "enable":true,"speed":1.5,"direction":"none","random":true,
          "straight":false,"out_mode":"out","bounce":false
        }
      },
      "interactivity":{
        "detect_on":"canvas",
        "events":{"onhover":{"enable":true,"mode":"repulse"},"onclick":{"enable":true,"mode":"push"}},
        "modes":{"repulse":{"distance":80,"duration":0.4},"push":{"particles_nb":3}}
      },
      "retina_detect":true
    });

    // 2. Typed line
    const boomLineEl=document.getElementById('boomLine');
    const boomLines=[
      "“Behold advanced tasks with sub-tasks & deadlines!”",
      "“Your tasks carry priorities, tags & CSV incantation!”",
      "“Beware of expired tasks and soared consecutive days!”",
      "“Wave your wand to reorder, conjure expansions!”"
    ];
    const line=boomLines[Math.floor(Math.random()*boomLines.length)];
    let i=0, speed=40;
    function typeWriter(){
      if(i<line.length){
        boomLineEl.textContent+=line.charAt(i);
        i++;
        setTimeout(typeWriter,speed);
      }
    }
    typeWriter();

    // 3. Emoji login
    const loginOverlay=document.getElementById('loginOverlay');
    const emojiSeqEl=document.getElementById('emojiSequence');
    const emojis=["🌸","🐙","🪄","🍎","🦉","🐛","🧁","🎩","🐬","🍄",
                  "💎","🍭","🍀","🐞","🌈","💫","⭐","🍋","🎃","🪐",
                  "⚡","🤖","🦀","🎁","👻","🍰","🌻","🚀"];
    let randomEmojis=[];
    const correctIndex=5;

    (function genEmojis(){
      for(let j=0;j<10;j++){
        const idx=Math.floor(Math.random()*emojis.length);
        randomEmojis.push(emojis[idx]);
      }
      let html="";
      randomEmojis.forEach((em,i)=>{
        html+=`<span data-idx="${i}">${em}</span>`;
      });
      emojiSeqEl.innerHTML=html;
    })();
    emojiSeqEl.addEventListener('click',(e)=>{
      if(e.target.matches('span')){
        const index=parseInt(e.target.dataset.idx);
        if(index===correctIndex){
          loginOverlay.style.display='none';
        }
      }
    });

    // 4. Expandable card
    const todoCard=document.getElementById('todoCard');
    todoCard.addEventListener('click',(e)=>{
      if(e.target.tagName.toLowerCase()==='h2'|| e.target.classList.contains('arrow')){
        todoCard.classList.toggle('expanded');
      }
    });

    // 5. ToDo data
    const recommendationBar=document.getElementById('recommendationBar');
    const taskProgressEl=document.getElementById('taskProgress');
    const mandatoryListEl=document.getElementById('mandatoryList');
    const optionalListEl=document.getElementById('optionalList');
    const addTaskForm=document.getElementById('addTaskForm');
    const inputTextEl=document.getElementById('inputText');
    const inputDeadlineEl=document.getElementById('inputDeadline');
    const inputTagsEl=document.getElementById('inputTags');
    const inputPriorityEl=document.getElementById('inputPriority');
    const inputTypeEl=document.getElementById('inputType');
    const hasSubtasksEl=document.getElementById('hasSubtasks');
    const exportCsvBtn=document.getElementById('exportCsvBtn');
    const rewindDateEl=document.getElementById('rewindDate');
    const rewindDescEl=document.getElementById('rewindDesc');
    const rewindBtn=document.getElementById('rewindBtn');
    const sortSelectEl=document.getElementById('sortSelect');
    const btnSort=document.getElementById('btnSort');
    const btnSimulateDay=document.getElementById('simulateDayBtn');
    const statsInfoEl=document.getElementById('statsInfo');

    // 用户心情(低=>2)
    let userMood=2;

    // 显示/隐藏提示
    if(userMood<3){
      recommendationBar.style.display='block';
    }

    // 每个任务:
    // { id, text, type:'mandatory'|'optional', done, consecutiveDays, lastDoneDate, deadline, priority, tags:['xxx','yyy'], subtasks:[{title, done}] }
    let tasks=[
      {
        id:101, text:"📗 阅读Harry Potter至少半章", type:"mandatory", done:false,
        consecutiveNotDoneDays:1, lastDoneDate:null, deadline:"2025-06-15",
        priority:"medium", tags:["Reading"], subtasks:[]
      },
      {
        id:102, text:"✏️ 写5句小日志", type:"mandatory", done:false,
        consecutiveNotDoneDays:2, lastDoneDate:null, deadline:"2025-06-10",
        priority:"high", tags:["Writing","Daily"], subtasks: [
          {title:"写中文3句", done:false},
          {title:"写英文2句", done:false},
        ]
      },
      {
        id:201, text:"🎨 Procreate创作图+配图句", type:"optional", done:true,
        consecutiveNotDoneDays:0, lastDoneDate:"2025-06-09", deadline:"",
        priority:"low", tags:["Art"], subtasks:[]
      }
    ];

    // 6. 渲染
    function renderTasks(){
      mandatoryListEl.innerHTML='';
      optionalListEl.innerHTML='';

      // 统计 done/ notdone
      let doneCount=0, notdoneCount=0;
      // 计算完成率
      tasks.forEach(t=>{
        if(t.done) doneCount++;
        else notdoneCount++;
      });
      const total=tasks.length;
      const rate=Math.floor((doneCount/total)*100);
      taskProgressEl.style.width=rate+'%';
      statsInfoEl.textContent=`Done: ${doneCount}, NotDone: ${notdoneCount}, Total: ${total}`;

      tasks.forEach(task=>{
        const li=document.createElement('li');
        li.classList.add('task-item');

        // checkbox done
        const check=document.createElement('input');
        check.type='checkbox';
        check.checked=task.done;
        check.addEventListener('change',()=>{
          task.done=check.checked;
          if(task.done){
            task.lastDoneDate=(new Date()).toISOString().split('T')[0];
            task.consecutiveNotDoneDays=0;
          }
          renderTasks();
        });
        li.appendChild(check);

        // text
        const textSpan=document.createElement('span');
        textSpan.classList.add('task-text');
        textSpan.textContent=`${task.text}`;

        // tags
        if(task.tags && task.tags.length>0){
          textSpan.textContent+= "  ["+task.tags.join("][")+"]";
        }
        // priority
        textSpan.textContent+= ` (${task.priority})`;

        li.appendChild(textSpan);

        // deadline
        if(task.deadline){
          const todayStr=new Date().toISOString().split('T')[0];
          const td=new Date(todayStr), dd=new Date(task.deadline);
          if(!task.done && dd<td) {
            // overdue
            const odSpan=document.createElement('span');
            odSpan.classList.add('overdue');
            odSpan.textContent="过期";
            li.appendChild(odSpan);
          }
        }

        // consecutive
        if(!task.done && task.consecutiveNotDoneDays>=2){
          const warn=document.createElement('span');
          warn.classList.add('highlight-warning');
          warn.textContent="未完成2+天";
          li.appendChild(warn);
        }

        // edit
        const editBtn=document.createElement('button');
        editBtn.textContent="Edit";
        editBtn.addEventListener('click',()=>{
          editTask(task);
        });
        li.appendChild(editBtn);

        // del
        const delBtn=document.createElement('button');
        delBtn.textContent="Del";
        delBtn.style.marginLeft='4px';
        delBtn.addEventListener('click',()=>{
          if(confirm("确认删除?")){
            tasks=tasks.filter(t=>t.id!==task.id);
            renderTasks();
          }
        });
        li.appendChild(delBtn);

        // 子任务
        if(task.subtasks && task.subtasks.length>0){
          const ulSub=document.createElement('ul');
          ulSub.classList.add('subtask-list');
          task.subtasks.forEach((st, idx)=>{
            const liSt=document.createElement('li');
            liSt.classList.add('subtask-item');
            const cb=document.createElement('input');
            cb.type='checkbox'; cb.checked=st.done;
            cb.addEventListener('change',()=>{
              st.done=cb.checked;
              // 如果所有子任务都done => 主任务done
              if(task.subtasks.every(s=>s.done)) {
                task.done=true;
                task.lastDoneDate=(new Date()).toISOString().split('T')[0];
                task.consecutiveNotDoneDays=0;
              } else {
                task.done=false;
              }
              renderTasks();
            });
            liSt.appendChild(cb);
            const sp=document.createElement('span');
            sp.textContent=st.title;
            liSt.appendChild(sp);
            liSt.appendChild(document.createElement('br'));
            ulSub.appendChild(liSt);
          });
          li.appendChild(ulSub);
        }

        if(task.type==='mandatory') mandatoryListEl.appendChild(li);
        else optionalListEl.appendChild(li);
      });
    }

    function editTask(task){
      const newText=prompt("任务标题：", task.text);
      if(newText!==null && newText.trim()!==''){
        task.text=newText.trim();
      }
      const newDeadline=prompt("Deadline (YYYY-MM-DD) 或留空:", task.deadline||'');
      if(newDeadline!==null) task.deadline=newDeadline.trim();

      const newTags=prompt("标签(逗号分隔):", task.tags.join(','));
      if(newTags!==null) {
        task.tags=newTags.split(',').map(x=>x.trim()).filter(x=>x);
      }

      const newPriority=prompt("优先级(high|medium|low):", task.priority||'medium');
      if(newPriority) task.priority=newPriority;

      renderTasks();
    }

    // 初次渲染
    renderTasks();

    // 7. Add Task
    addTaskForm.addEventListener('submit',(e)=>{
      e.preventDefault();
      const txt=inputTextEl.value.trim();
      if(!txt){ alert("请输入任务标题"); return; }
      const dateVal=inputDeadlineEl.value.trim();
      const tagVal=inputTagsEl.value.trim();
      const prVal=inputPriorityEl.value;
      const tpVal=inputTypeEl.value;
      const subVal=hasSubtasksEl.checked;

      const newId=Date.now();
      const newTask={
        id:newId,
        text:txt,
        type:tpVal,
        done:false,
        consecutiveNotDoneDays:0,
        lastDoneDate:null,
        deadline: dateVal || "",
        priority: prVal,
        tags: tagVal? tagVal.split(',').map(x=>x.trim()).filter(x=>x):[],
        subtasks: subVal? [
          // demo: 你可弹框让用户逐个录入
          {title:"子任务1", done:false},
          {title:"子任务2", done:false}
        ] : []
      };
      tasks.push(newTask);
      inputTextEl.value='';
      inputDeadlineEl.value='';
      inputTagsEl.value='';
      hasSubtasksEl.checked=false;

      renderTasks();
    });

    // 8. Time Rewind => 降 consecutiveNotDoneDays
    rewindBtn.addEventListener('click',()=>{
      const dVal=rewindDateEl.value;
      const desc=rewindDescEl.value.trim();
      if(!dVal){
        alert("请选择补登日期");
        return;
      }
      // Demo: 找一个未完成的任务 => 让 consecutiveDays=0
      // 也可把desc写到日志 or push到 tasks
      tasks.forEach(t=>{
        if(!t.done && t.consecutiveNotDoneDays>0){
          t.consecutiveNotDoneDays=0;
          // t.lastDoneDate=dVal; // 也可设置
        }
      });
      alert("已补登: "+desc+" @"+ dVal);
      rewindDateEl.value='';
      rewindDescEl.value='';
      renderTasks();
    });

    // 9. Export CSV (带日期)
    exportCsvBtn.addEventListener('click',()=>{
      const todayStr=new Date().toISOString().split('T')[0];
      let csv="id,text,type,done,consecutiveDays,lastDoneDate,deadline,priority,tags,subtasks\n";
      tasks.forEach(t=>{
        // tags,subtasks => JSON.stringify
        const tagsStr=(t.tags||[]).join('|');
        const subsStr= (t.subtasks||[]).map(s=>`${s.title}(${s.done?'done':'not'})`).join('|');
        const row=`${t.id},"${t.text.replace(/"/g,'""')}",${t.type},${t.done},${t.consecutiveNotDoneDays},${t.lastDoneDate||''},${t.deadline||''},${t.priority||''},"${tagsStr}","${subsStr}"`;
        csv+=row+"\n";
      });
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const link=document.createElement('a');
      link.href=url; link.download=`tasks_${todayStr}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    });

    // 10. Sorting
    btnSort.addEventListener('click',()=>{
      const mode=sortSelectEl.value;
      if(mode==='deadline'){
        tasks.sort((a,b)=>{
          if(!a.deadline && !b.deadline) return 0;
          if(!a.deadline) return 1; // 无deadline排后
          if(!b.deadline) return -1;
          return (new Date(a.deadline) - new Date(b.deadline));
        });
      } else if(mode==='done'){
        // 未完成在前,完成在后
        tasks.sort((a,b)=> Number(a.done)-Number(b.done));
      } else if(mode==='priority'){
        // high < medium < low
        const order={"high":1,"medium":2,"low":3};
        tasks.sort((a,b)=> (order[a.priority]||2) - (order[b.priority]||2));
      } else {
        // none
      }
      renderTasks();
    });

    // 11. simulate +1 day => consecutiveNotDoneDays++
    btnSimulateDay.addEventListener('click',()=>{
      // demo: if a task not done => consecutiveDays++
      tasks.forEach(t=>{
        if(!t.done){
          t.consecutiveNotDoneDays++;
        }
      });
      alert("已模拟过1天, 未完成任务 consecutiveNotDoneDays+1");
      renderTasks();
    });
  </script>
</body>
</html>
