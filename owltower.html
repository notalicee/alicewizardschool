<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Owl Tower Console</title>

  <!-- Pangolin Â≠ó‰Ωì -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Pangolin&display=swap"
    rel="stylesheet"
  >

  <!-- particles.js -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <style>
    /* ========== RESET & GLOBAL ========== */
    * {
      margin:0; padding:0; box-sizing:border-box;
    }
    body {
      display:flex; min-height:100vh; position:relative; overflow-x:hidden;
      font-family:'Pangolin', cursive; font-size:18px; line-height:1.6;
      color:#4d3b2f;
    }
    #particles-js {
      position:fixed; top:0; left:0; width:100%; height:100%;
      z-index:-1; background:#f6f2e7;
    }
    a { text-decoration:none; color:inherit; transition:color 0.3s; }
    a:hover { color:#b38b14; }

    /* ========== Sidebar ========== */
    .sidebar {
      width:220px; background:#3d3c2e; padding:2rem 1rem;
      position:fixed; top:0; bottom:0; left:0;
      display:flex; flex-direction:column; z-index:10;
    }
    .sidebar .title {
      font-size:2rem; color:#fce6c9; text-align:center;
      margin-bottom:2rem;
    }
    .nav-links { list-style:none; font-size:1.25rem; }
    .nav-links li { margin-bottom:1.2rem; }
    .nav-links li a {
      color:#fce6c9; font-weight:bold;
      padding:0.4rem 0.6rem; border-radius:6px;
      display:inline-block; transition:background 0.3s;
    }
    .nav-links li a:hover {
      background:#b38b14; color:#fff;
    }
    .active { background:#b38b14; color:#fff; }

    /* ========== Main Content ========== */
    .main-content {
      margin-left:220px; flex:1; padding:2rem;
      position:relative; z-index:10;
    }
    .header-row {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:1rem;
    }
    .header-title { font-size:2rem; color:#b38b14; }

    /* ========== BoomBoom typed bar ========== */
    .boom-bar {
      background:#fff8e1; border:2px dashed #b38b14; border-radius:10px;
      padding:1rem; margin-bottom:1rem;
      display:flex; align-items:center; gap:1rem;
    }
    .boom-avatar {
      width:60px; height:60px; border-radius:50%;
      background:#fff3c1; overflow:hidden; flex-shrink:0;
    }
    .boom-avatar img {
      width:100%; height:100%; object-fit:cover;
    }
    .boom-text { flex:1; }
    .boom-text h2 {
      font-size:1.4rem; color:#8c6e0c; margin-bottom:0.25rem;
    }
    .typed-line {
      color:#6b4b0c; font-size:1rem; white-space:pre-wrap;
    }

    /* ========== Backend Nav ========== */
    .backend-nav {
      display:flex; gap:1rem; margin-bottom:1rem;
    }
    .backend-nav button {
      background:#8b6d0c; color:#fff; border:none; border-radius:6px;
      padding:0.5rem 1rem; cursor:pointer;
    }
    .backend-nav button:hover { background:#b38b14; }

    /* ========== Card Modules ========== */
    .card {
      background: #fffef6;
      border: 2px dashed #d0bb8c;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .sub-card {
      background: #fffbf0;
      border: 2px dashed #e0c990;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .todo-title {
      font-size:1.3rem; color:#5c4b12;
      margin-bottom:0.5rem;
    }

    /* Recommendation, progress */
    .recommendation {
      margin:0.5rem 0; padding:0.4rem;
      border-left:4px solid #f77; background:#fffaea;
    }
    .progress-bar-container {
      margin-top:1rem; background:#eee; border-radius:6px;
      overflow:hidden; height:18px; width:80%; max-width:400px;
    }
    .progress-bar {
      height:100%; background:#b38b14; width:0%; transition:width 0.4s;
    }

    /* Editor top: lists */
    .task-category { margin-bottom:1rem; }
    .task-category h3 {
      margin-bottom:0.5rem; color:#b38b14; font-size:1.1rem;
    }
    .task-category ul {
      list-style:none; margin-left:1rem; padding-left:0;
    }

    /* Each main task is block, with subtask below */
    .task-item {
      /* block layout so subtask list can be below, not inline */
      display:block;
      border-bottom:1px dashed #d0bb8c;
      margin-bottom:0.8rem;
      padding-bottom:0.5rem;
    }
    .task-item-top {
      display:flex; align-items:center; gap:0.5rem;
      margin-bottom:0.3rem;
    }
    .done-chk {
      transform: scale(1.2);
      margin-right: 0.6rem;
      margin-left: 0;
      order: 0;
    }
    .push-chk {
      transform: scale(1.2);
      margin-left: auto;
      margin-right: 0;
      order: 99;
    }
    .push-btn {
      background: #f7e3b2;
      color: #8b6d0c;
      border: 2px dashed #d0bb8c;
      border-radius: 6px;
      padding: 0.3rem 0.7rem;
      font-size: 0.95rem;
      cursor: pointer;
      margin-left: auto;
      margin-right: 0;
      order: 99;
      transition: background 0.2s;
    }
    .push-btn:hover {
      background: #ffe7c2;
      color: #b38b14;
    }
    .diff-label {
      font-size:0.9rem; font-weight:bold; text-align:center;
      border-radius:4px; width:60px; margin-right:0.5rem; color:#fff;
    }
    .diff-high { background:red; }
    .diff-medium { background:orange; }
    .diff-low { background:gold; color:#333; }

    .cat-label {
      border:1px solid #ccc; border-radius:6px; padding:0.2rem 0.4rem;
      font-size:0.8rem; background:#fff4d2; color:#333; margin-right:0.5rem;
    }
    .task-text { flex:1; }
    .highlight-warning {
      background:#ffe5e5; padding:0.2rem 0.4rem; border-radius:4px;
      margin-left:0.5rem; color:#c30;
    }
    .task-item-top button {
      background:#d8c593; border:none; border-radius:4px;
      padding:0.3rem 0.6rem; cursor:pointer; color:#4d3b2f; font-size:0.9rem;
    }
    .task-item-top button:hover { background:#b9a377; }

    /* subtask below, left indent */
    .subtask-list {
      margin-left:2rem;
    }
    .subtask-item {
      display:flex; align-items:center; gap:0.4rem;
      margin-bottom:0.2rem;
    }

    /* AddTask bottom module */
    .todo-addpanel {
      margin-top:1rem; border-top:1px solid #d0bb8c; padding-top:1rem;
    }
    .todo-addpanel h3 {
      font-size:1.1rem; color:#5c4b12; margin-bottom:0.5rem;
    }
    .add-task-form {
      display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;
    }
    .add-task-form input[type="text"] {
      border:1px solid #ccc; border-radius:6px; padding:0.4rem;
    }
    .add-task-form select {
      border:1px solid #ccc; border-radius:6px; padding:0.4rem;
    }
    .add-task-form button {
      background:#8b6d0c; color:#fff; border:none;
      border-radius:6px; padding:0.5rem 1rem; cursor:pointer;
    }
    .add-task-form button:hover { background:#b38b14; }

    /* subtask dynamic area */
    .subtask-dynamic {
      margin-top:0.5rem; padding:0.5rem; border:1px solid #ccc;
      border-radius:6px; background:#fffef6;
    }
    .subtask-dynamic h4 { margin-bottom:0.5rem; }
    .subtask-row {
      display:flex; gap:0.5rem; align-items:center;
      margin-bottom:0.5rem;
    }
    .subtask-row input[type="text"] {
      flex:1; border:1px solid #ccc; border-radius:6px; padding:0.4rem;
    }
    .subtask-row button {
      background:#d8c593; color:#4d3b2f; border:none; border-radius:6px;
      padding:0.3rem 0.6rem; cursor:pointer;
    }
    .subtask-row button:hover { background:#b9a377; }

    /* ========== Emoji Lock Overlay ========== */
    .login-overlay {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5);
      display:flex; justify-content:center; align-items:center;
      z-index:999;
    }
    .login-box {
      background:#fffef6; border:2px dashed #d0bb8c; border-radius:10px;
      width:360px; padding:1rem; text-align:center; position:relative;
    }
    .login-box h3 {
      margin-bottom:0.5rem; color:#5c4b12; font-size:1.4rem;
    }
    .emoji-sequence {
      display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap;
      font-size:1.8rem; user-select:none; margin-top:1rem;
    }
    .emoji-sequence span {
      cursor:pointer; padding:0.2rem; transition:transform 0.2s;
    }
    .emoji-sequence span:hover { transform:scale(1.2); }

    /* Responsive */
    @media(max-width:768px){
      .sidebar { width:180px; }
      .main-content { margin-left:180px; }
      .login-box { width:280px; }
      .emoji-sequence { font-size:1.6rem; }
    }
  </style>
</head>
<body>
  <!-- Á≤íÂ≠êËÉåÊôØ -->
  <div id="particles-js"></div>

  <!-- ‰æßËæπÊ†è -->
  <aside class="sidebar">
    <div class="title">Wizard Navigation</div>
    <ul class="nav-links">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="badge.html">Badge Room</a></li>
      <li><a href="wishmood.html">Wish & Mood</a></li>
      <li><a href="destiny.html">Destiny Room</a></li>
      <li><a href="owltower.html" class="active">Owl Tower</a></li>
    </ul>
  </aside>

    <main class="main-content">
      <div class="header-row">
        <h1 class="header-title">Boom Boom‚Äôs Owl Tower Console ü¶âüè∞</h1>
      </div>

      <!-- BoomBoom typed line -->
      <div class="boom-bar">
        <div class="boom-avatar">
          <!-- ÊõøÊç¢‰∏∫‰Ω†ÁöÑ owl-talk.png -->
          <img src="assets/images/owl-talk.png" alt="BoomBoom" />
        </div>
        <div class="boom-text">
          <h2>Tasks & Subtasks Demo</h2>
          <div class="typed-line" id="typedLine"></div>
        </div>
      </div>

      <!-- ÂêéÂè∞ÂØºËà™ÊåâÈíÆ -->
      <div class="backend-nav">
        <button id="btnTasksTodos" class="nav-toggle-btn">Tasks & ToDos</button>
        <button>Badge & Fragments</button>
        <button>Wish & Mood</button>
        <button>Destiny Summer</button>
        <button id="btnTimeRewind" class="nav-toggle-btn">Time Rewind</button>
      </div>

      <!-- ‰ªªÂä°Â±ïÁ§∫Âç°Áâá -->
      <div id="task-display-card" class="card">
        <h2 class="todo-title">To-Do List Editor</h2>
        <!-- 1) Editor Top: rec + progress + tasks -->
        <div id="todoDisplay">
          <div class="recommendation" id="moodRec" style="display:none;">
            <strong>Low mood detected!</strong> Suggest simpler tasks & fewer pushes.
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progBar"></div>
          </div>

          <div class="task-category">
            <h3>üìå Mandatory Tasks</h3>
            <ul id="mandList"></ul>
          </div>
          <div class="task-category">
            <h3>üéØ Optional Tasks</h3>
            <ul id="optList"></ul>
          </div>
        </div>
      </div>

      <!-- ‰ªªÂä°Ê∑ªÂä†Âç°Áâá -->
      <div id="task-add-card" class="card">
        <div class="todo-addpanel">
          <h3>Add New Task</h3>
          <form class="add-task-form" id="addTaskForm">
            <input type="text" id="taskTitle" placeholder="Task Title" />
            <select id="taskDiff">
              <option value="high">High</option>
              <option value="medium" selected>Medium</option>
              <option value="low">Low</option>
            </select>
            <select id="taskCat">
              <option value="mandatory">Mandatory</option>
              <option value="optional">Optional</option>
            </select>
            <label>Subtask?
              <input type="checkbox" id="subtaskChk" />
            </label>
            <button type="submit">Add Task</button>
          </form>

          <!-- Subtask dynamic area -->
          <div class="subtask-dynamic" id="subtaskArea" style="display:none;">
            <h4>Subtasks</h4>
            <div id="subtaskRows"></div>
            <button id="btnAddSubtask" style="margin-top:0.5rem;">+ Subtask</button>
          </div>

          <button id="btnExportCsv" style="margin-top:1rem;">Export CSV</button>
        </div>
      </div>

      <!-- Time Rewind Âç°ÁâáÁªìÊûÑÔºåÈªòËÆ§ÈöêËóè -->
      <div id="rewind-section" class="card" style="display:none;">
        <h2 class="todo-title">Time Rewind</h2>
        <div class="sub-card" id="todo-rewind-card">
          <h3>ToDo Rewind</h3>
          <form id="todoRewindForm" style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
            <label>
              Êó•Êúü:
              <input type="date" id="todoRewindDate" />
            </label>
            <label>
              ÊèèËø∞:
              <input type="text" id="todoRewindDesc" placeholder="ÊèèËø∞..." />
            </label>
            <button type="button" id="btnBackfill">Backfill</button>
            <button type="button" id="btnExportRewindCsv">ÂØºÂá∫ CSV</button>
          </form>
        </div>
        <div class="sub-card">
          <h3>Badge Rewind</h3>
          <!-- ÂèØÊâ©Â±ïÂÜÖÂÆπ -->
        </div>
        <div class="sub-card">
          <h3>Wish Rewind</h3>
          <!-- ÂèØÊâ©Â±ïÂÜÖÂÆπ -->
        </div>
        <div class="sub-card">
          <h3>Destiny Rewind</h3>
          <!-- ÂèØÊâ©Â±ïÂÜÖÂÆπ -->
        </div>
      </div>
    </main>

  <!-- Emoji Lock Overlay -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h3>Emoji Magic Lock</h3>
      <div class="emoji-sequence" id="emojiSeq"></div>
    </div>
  </div>

  <script>
    // ========== 0. Particles ==========
    particlesJS("particles-js", {
      "particles":{
        "number":{"value":50,"density":{"enable":true,"value_area":800}},
        "color":{"value":["#FFFBE6","#FFD700","#FFECB3"]},
        "shape":{"type":"star","stroke":{"width":0,"color":"#ffffff"}},
        "opacity":{"value":0.8,"random":true},
        "size":{"value":6,"random":true},
        "line_linked":{"enable":false},
        "move":{
          "enable":true,"speed":1.5,"direction":"none","random":true,
          "straight":false,"out_mode":"out","bounce":false
        }
      },
      "interactivity":{
        "detect_on":"canvas",
        "events":{
          "onhover":{"enable":true,"mode":"repulse"},
          "onclick":{"enable":true,"mode":"push"}
        },
        "modes":{
          "repulse":{"distance":80,"duration":0.4},
          "push":{"particles_nb":3}
        }
      },
      "retina_detect":true
    });

    // ========== 1. Typed line ==========
    const typedEl=document.getElementById('typedLine');
    const typedLines=[
      "‚ÄúNow tasks are in two separate modules‚Äîlike dashboard!‚Äù",
      "‚ÄúSubtasks appear below the main task, left-indented!‚Äù"
    ];
    let i=0; const speed=45;
    const line=typedLines[Math.floor(Math.random()*typedLines.length)];
    function doTyping(){
      if(i<line.length){
        typedEl.textContent+=line.charAt(i);
        i++;
        setTimeout(doTyping,speed);
      }
    }
    doTyping();

    // ========== 2. Emoji Lock (6th) ==========
    const lockOverlay=document.getElementById('loginOverlay');
    const seqEl=document.getElementById('emojiSeq');
    const emojis=["üå∏","üêô","ü™Ñ","üçé","ü¶â","üêõ","üßÅ","üé©","üê¨","üçÑ","üíé","üç≠","üçÄ","üêû","üåà","üí´","‚≠ê","üçã","üéÉ","ü™ê","‚ö°","ü§ñ","ü¶Ä","üéÅ","üëª","üç∞","üåª","üöÄ"];
    let randomArr=[];
    const correctIdx=5;
    (function genEmojis(){
      for(let j=0;j<10;j++){
        const rdx=Math.floor(Math.random()*emojis.length);
        randomArr.push(emojis[rdx]);
      }
      let ht="";
      randomArr.forEach((em,i)=>{
        ht+=`<span data-idx="${i}">${em}</span>`;
      });
      seqEl.innerHTML=ht;
    })();
    seqEl.addEventListener('click',(e)=>{
      if(e.target.matches('span')){
        const idx=parseInt(e.target.dataset.idx);
        if(idx===correctIdx){
          lockOverlay.style.display='none';
        }
      }
    });

    // ========== 3. ToDo Logic ==========
    const moodRec=document.getElementById('moodRec');
    let userMood=2;
    if(userMood<3) moodRec.style.display='block';

    const progBar=document.getElementById('progBar');
    const mandList=document.getElementById('mandList');
    const optList=document.getElementById('optList');

    // Sample tasks
    let tasks=[
      {
        id:101,
        text:"üìó ÈòÖËØª Harry Potter",
        difficulty:"high",
        type:"mandatory",
        done:false,
        consecutiveDays:2,
        subtasks:[
          {title:"Á¨¨1Â∞èËäÇ", done:true},
          {title:"Á¨¨2Â∞èËäÇ", done:false}
        ]
      },
      {
        id:201,
        text:"üíª ÂÅöScience Notebook",
        difficulty:"medium",
        type:"optional",
        done:true,
        consecutiveDays:0,
        subtasks:[]
      }
    ];

    function renderTasks(){
      mandList.innerHTML='';
      optList.innerHTML='';

      let total=tasks.length, doneCount=tasks.filter(t=>t.done).length;
      let rate=Math.floor((doneCount/total)*100);
      progBar.style.width=rate+'%';

      tasks.forEach(task=>{
        const li=document.createElement('li');
        li.classList.add('task-item');

        // top row
        const topRow=document.createElement('div');
        topRow.classList.add('task-item-top');

        // 1) ÂÆåÊàêÁä∂ÊÄÅ checkbox (ÊúÄÂ∑¶)
        const doneChk=document.createElement('input');
        doneChk.type='checkbox';
        doneChk.checked=task.done;
        doneChk.classList.add('done-chk');
        doneChk.addEventListener('change',()=>{
          task.done=doneChk.checked;
          if(task.done) task.consecutiveDays=0;
          renderTasks();
        });
        topRow.appendChild(doneChk);

        // 2) difficulty label
        const diffSpan=document.createElement('span');
        diffSpan.classList.add('diff-label');
        if(task.difficulty==='high') diffSpan.classList.add('diff-high');
        else if(task.difficulty==='medium') diffSpan.classList.add('diff-medium');
        else diffSpan.classList.add('diff-low');
        diffSpan.textContent=task.difficulty;
        topRow.appendChild(diffSpan);

        // 3) category
        const catSpan=document.createElement('span');
        catSpan.classList.add('cat-label');
        catSpan.textContent=task.type;
        topRow.appendChild(catSpan);

        // 4) title text
        const txtSpan=document.createElement('span');
        txtSpan.classList.add('task-text');
        txtSpan.textContent=task.text;
        topRow.appendChild(txtSpan);

        // 5) consecutive days highlight
        if(!task.done && task.consecutiveDays>=2){
          const warn=document.createElement('span');
          warn.classList.add('highlight-warning');
          warn.textContent="Êú™ÂÆåÊàê2+Â§©";
          topRow.appendChild(warn);
        }

        // 6) edit
        const eBtn=document.createElement('button');
        eBtn.textContent='Edit';
        eBtn.addEventListener('click',()=>{
          let newVal=prompt("ÁºñËæë‰ªªÂä°Ôºö",task.text);
          if(newVal && newVal.trim()){
            task.text=newVal.trim();
            renderTasks();
          }
        });
        topRow.appendChild(eBtn);

        // 7) del
        const dBtn=document.createElement('button');
        dBtn.textContent='Del';
        dBtn.style.marginLeft='4px';
        dBtn.addEventListener('click',()=>{
          if(confirm("Á°ÆËÆ§Âà†Èô§Ôºü")){
            tasks=tasks.filter(tt=>tt.id!==task.id);
            renderTasks();
          }
        });
        topRow.appendChild(dBtn);

        // 8) Êé®ÈÄÅÂà∞DashboardÊåâÈíÆ (ÊúÄÂè≥)
        const pushBtn=document.createElement('button');
        pushBtn.classList.add('push-btn');
        pushBtn.textContent='Êé®ÈÄÅÂà∞ Dashboard';
        pushBtn.addEventListener('click',()=>{
          let stored=JSON.parse(localStorage.getItem('pushedTasks')||'[]');
          if(!stored.find(x=>x.id===task.id)){
            stored.push(task);
            localStorage.setItem('pushedTasks',JSON.stringify(stored));
            alert(`Â∑≤Êé®ÈÄÅÂà∞Dashboard: ${task.text}`);
          } else {
            alert('Â∑≤Êé®ÈÄÅËøáËØ•‰ªªÂä°');
          }
        });
        topRow.appendChild(pushBtn);

        li.appendChild(topRow);

        // 9) subtask below
        if(task.subtasks && task.subtasks.length>0){
          const ulSt=document.createElement('ul');
          ulSt.classList.add('subtask-list');
          task.subtasks.forEach(st=>{
            const stLi=document.createElement('li');
            stLi.classList.add('subtask-item');
            const stChk=document.createElement('input');
            stChk.type='checkbox'; stChk.checked=st.done;
            stChk.addEventListener('change',()=>{
              st.done=stChk.checked;
              if(task.subtasks.every(x=>x.done)){
                task.done=true; task.consecutiveDays=0;
              } else {
                task.done=false;
              }
              renderTasks();
            });
            stLi.appendChild(stChk);
            const stSpan=document.createElement('span');
            stSpan.textContent=st.title;
            stLi.appendChild(stSpan);
            // --- Add Edit button for subtask ---
            const editSubBtn = document.createElement('button');
            editSubBtn.textContent = 'Edit';
            editSubBtn.style.marginLeft = '6px';
            editSubBtn.addEventListener('click', () => {
              const newTitle = prompt("ÁºñËæëÂ≠ê‰ªªÂä°Ôºö", st.title);
              if (newTitle && newTitle.trim()) {
                st.title = newTitle.trim();
                renderTasks();
              }
            });
            stLi.appendChild(editSubBtn);
            ulSt.appendChild(stLi);
          });
          li.appendChild(ulSt);
        }

        // put into mandatory/optional
        if(task.type==='mandatory'){
          mandList.appendChild(li);
        } else {
          optList.appendChild(li);
        }
      });
    }
    renderTasks();

    // ========== AddTask with subtask dynamic ==========

    const addTaskForm=document.getElementById('addTaskForm');
    const taskTitleEl=document.getElementById('taskTitle');
    const taskDiffEl=document.getElementById('taskDiff');
    const taskCatEl=document.getElementById('taskCat');
    const subtaskChkEl=document.getElementById('subtaskChk');
    const subtaskAreaEl=document.getElementById('subtaskArea');
    const subtaskRowsEl=document.getElementById('subtaskRows');
    const btnAddSubtask=document.getElementById('btnAddSubtask');
    const btnExportCsv=document.getElementById('btnExportCsv');

    subtaskChkEl.addEventListener('change',()=>{
      if(subtaskChkEl.checked){
        subtaskAreaEl.style.display='block';
      } else {
        subtaskAreaEl.style.display='none';
        subtaskRowsEl.innerHTML='';
      }
    });

    btnAddSubtask.addEventListener('click',()=>{
      const row=document.createElement('div');
      row.classList.add('subtask-row');
      const inp=document.createElement('input');
      inp.type='text'; inp.placeholder="Subtask Title...";
      const delBtn=document.createElement('button');
      delBtn.textContent='Del';
      delBtn.addEventListener('click',()=>{
        subtaskRowsEl.removeChild(row);
      });
      row.appendChild(inp);
      row.appendChild(delBtn);
      subtaskRowsEl.appendChild(row);
    });

    addTaskForm.addEventListener('submit',(e)=>{
      e.preventDefault();
      const txt=taskTitleEl.value.trim();
      const diff=taskDiffEl.value;
      const cat=taskCatEl.value;
      if(!txt){
        alert("ËØ∑ËæìÂÖ•‰ªªÂä°Ê†áÈ¢ò");
        return;
      }
      let newId=Date.now();
      let subtasksArr=[];
      if(subtaskChkEl.checked){
        const rowDivs=subtaskRowsEl.querySelectorAll('.subtask-row');
        rowDivs.forEach(div=>{
          const inp=div.querySelector('input[type="text"]');
          if(inp && inp.value.trim()){
            subtasksArr.push({title:inp.value.trim(), done:false});
          }
        });
      }

      let newTask={
        id:newId,
        text:txt,
        difficulty:diff,
        type:cat,
        done:false,
        consecutiveDays:0,
        subtasks:subtasksArr
      };
      tasks.push(newTask);

      // reset
      taskTitleEl.value='';
      subtaskChkEl.checked=false;
      subtaskAreaEl.style.display='none';
      subtaskRowsEl.innerHTML='';

      renderTasks();
    });

    // CSV export
    btnExportCsv.addEventListener('click',()=>{
      const todayStr=new Date().toISOString().split('T')[0];
      let csv="id,text,difficulty,type,done,consecutiveDays,subtasks\n";
      tasks.forEach(t=>{
        let sub=(t.subtasks||[]).map(s=> s.title+(s.done?"(done)":"(no)")).join("|");
        let row=`${t.id},"${t.text.replace(/"/g,'""')}",${t.difficulty},${t.type},${t.done},${t.consecutiveDays},"${sub}"`;
        csv+=row+"\n";
      });
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const link=document.createElement('a');
      link.href=url;
      link.download=`tasks_${todayStr}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    });

    // ========== Time Rewind ÊòæÈöêÂàáÊç¢ÈÄªËæë ==========
    const btnTasksTodos = document.getElementById('btnTasksTodos');
    const btnTimeRewind = document.getElementById('btnTimeRewind');
    const taskDisplayCard = document.getElementById('task-display-card');
    const taskAddCard = document.getElementById('task-add-card');
    const rewindSection = document.getElementById('rewind-section');

    function showTasksTodos() {
      taskDisplayCard.style.display = '';
      taskAddCard.style.display = '';
      rewindSection.style.display = 'none';
      btnTasksTodos.classList.add('active');
      btnTimeRewind.classList.remove('active');
    }
    function showTimeRewind() {
      taskDisplayCard.style.display = 'none';
      taskAddCard.style.display = 'none';
      rewindSection.style.display = '';
      btnTimeRewind.classList.add('active');
      btnTasksTodos.classList.remove('active');
    }
    btnTasksTodos.addEventListener('click', showTasksTodos);
    btnTimeRewind.addEventListener('click', showTimeRewind);
    // ÈªòËÆ§ÊòæÁ§∫‰ªªÂä°Âç°Áâá
    showTasksTodos();

    // ========== ToDo Rewind Â≠êÂç°ÁâáÊåâÈíÆÈÄªËæë ==========
    const btnExportRewindCsv = document.getElementById('btnExportRewindCsv');
    const todoRewindDate = document.getElementById('todoRewindDate');
    const todoRewindDesc = document.getElementById('todoRewindDesc');
    const btnBackfill = document.getElementById('btnBackfill');

    btnExportRewindCsv.addEventListener('click',()=>{
      let dateStr = todoRewindDate.value || new Date().toISOString().split('T')[0];
      let desc = todoRewindDesc.value || '';
      let csv = "date,desc\n";
      csv += `"${dateStr}","${desc.replace(/"/g,'""')}"\n`;
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `todo_rewind_${dateStr}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    });

    btnBackfill.addEventListener('click',()=>{
      alert(`Backfill: ${todoRewindDate.value} - ${todoRewindDesc.value}`);
    });
  </script>
</body>
</html>
