<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Owl Tower Console</title>

  <!-- Pangolin Â≠ó‰Ωì -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link 
    href="https://fonts.googleapis.com/css2?family=Pangolin&display=swap" 
    rel="stylesheet"
  >

  <!-- particles.js -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <style>
    /* ========== RESET & GLOBAL ========== */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      display:flex; min-height:100vh; position:relative; overflow-x:hidden;
      font-family:'Pangolin',cursive; font-size:18px; line-height:1.6;
      color:#4d3b2f;
    }
    #particles-js {
      position:fixed; top:0; left:0; width:100%; height:100%;
      z-index:-1; background:#f6f2e7;
    }
    a { text-decoration:none; color:inherit; transition:color 0.3s; }
    a:hover { color:#b38b14; }

    /* ========== Sidebar ========== */
    .sidebar {
      width:220px; background:#3d3c2e; padding:2rem 1rem;
      position:fixed; top:0; bottom:0; left:0;
      display:flex; flex-direction:column; z-index:10;
    }
    .sidebar .title {
      font-size:2rem; color:#fce6c9; text-align:center;
      margin-bottom:2rem;
    }
    .nav-links { list-style:none; font-size:1.25rem; }
    .nav-links li { margin-bottom:1.2rem; }
    .nav-links li a {
      color:#fce6c9; font-weight:bold;
      padding:0.4rem 0.6rem; border-radius:6px;
      display:inline-block; transition:background 0.3s;
    }
    .nav-links li a:hover {
      background:#b38b14; color:#fff;
    }
    .active { background:#b38b14; color:#fff; }

    /* ========== Main Content ========== */
    .main-content {
      margin-left:220px; flex:1; padding:2rem;
      position:relative; z-index:10;
    }
    .header-row {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:1rem;
    }
    .header-title { font-size:2rem; color:#b38b14; }

    /* ========== BoomBoom typed line ========== */
    .boom-bar {
      background:#fff8e1; border:2px dashed #b38b14; border-radius:10px;
      padding:1rem; margin-bottom:1rem;
      display:flex; align-items:center; gap:1rem;
    }
    .boom-avatar {
      width:60px; height:60px; border-radius:50%;
      background:#fff3c1; overflow:hidden; flex-shrink:0;
    }
    .boom-avatar img {
      width:100%; height:100%; object-fit:cover;
    }
    .boom-text { flex:1; }
    .boom-text h2 {
      font-size:1.4rem; color:#8c6e0c; margin-bottom:0.25rem;
    }
    .typed-line {
      color:#6b4b0c; font-size:1rem; white-space:pre-wrap;
    }

    /* ========== Backend Nav (horizontal) ========== */
    .backend-nav {
      display:flex; gap:1rem; margin-bottom:1rem;
    }
    .backend-nav button {
      background:#8b6d0c; color:#fff; border:none;
      border-radius:6px; padding:0.5rem 1rem; cursor:pointer;
    }
    .backend-nav button:hover { background:#b38b14; }

    /* ========== Expandable Card ========== */
    .expandable-card {
      background:#fffef6; border:2px dashed #d0bb8c; border-radius:10px;
      margin-bottom:1rem; overflow:hidden;
      transition:max-height 0.5s, padding 0.5s;
    }
    .expandable-card h2 {
      font-size:1.3rem; color:#5c4b12; margin:0; padding:1rem;
      cursor:pointer; display:flex; align-items:center; justify-content:space-between;
    }
    .expandable-card h2:hover { background:#fff4c2; }
    .expandable-card .content {
      padding:0 1rem; max-height:0; overflow:hidden;
    }
    .expandable-card.expanded .content {
      max-height:2000px; padding-bottom:1rem;
    }
    .arrow {
      font-size:1.2rem; transition:transform 0.3s;
    }
    .expanded .arrow { transform:rotate(90deg); }

    /* ========== Recommendation, progress ========== */
    .recommendation {
      margin:0.5rem 0; padding:0.4rem;
      border-left:4px solid #f77; background:#fffaea;
    }
    .progress-bar-container {
      margin-top:1rem; background:#eee; border-radius:6px;
      overflow:hidden; height:18px; width:80%; max-width:400px;
    }
    .progress-bar {
      height:100%; background:#b38b14; width:0%; transition:width 0.4s;
    }

    /* ========== Task Lists ========== */
    .task-category { margin-bottom:1rem; }
    .task-category h3 {
      margin-bottom:0.5rem; color:#b38b14; font-size:1.1rem;
    }
    .task-category ul {
      list-style:none; margin-left:1rem; padding-left:0;
    }
    .task-item {
      display:flex; align-items:center; gap:0.5rem;
      margin-bottom:0.5rem;
    }

    /* ‚ÄúÊé®ÈÄÅÂà∞Dashboard‚Äù */
    .push-chk { transform:scale(1.2); }

    /* ÈöæÂ∫¶ color block */
    .diff-label {
      font-size:0.9rem; font-weight:bold; text-align:center;
      border-radius:4px; width:60px; margin-right:0.5rem;
      color:#fff;
    }
    .diff-high { background:red; }
    .diff-medium { background:orange; }
    .diff-low { background:gold; color:#333; }

    /* Á±ªÂà´ */
    .cat-label {
      border:1px solid #ccc; border-radius:6px; padding:0.2rem 0.4rem;
      font-size:0.8rem; background:#fff4d2; color:#333; margin-right:0.5rem;
    }
    .task-text { flex:1; }

    .highlight-warning {
      background:#ffe5e5; padding:0.2rem 0.4rem; border-radius:4px;
      margin-left:0.5rem; color:#c30;
    }

    /* Subtask */
    .subtask-list { margin:0.2rem 0 0.2rem 2rem; }
    .subtask-item { display:flex; gap:0.4rem; align-items:center; margin-bottom:0.2rem; }

    /* Add Task Form */
    .editor-footer { margin-top:1rem; }
    .add-task-form {
      display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;
      margin-top:0.5rem;
    }
    .add-task-form input[type="text"] {
      flex:1; border:1px solid #ccc; border-radius:6px;
      padding:0.4rem;
    }
    .add-task-form select {
      border:1px solid #ccc; border-radius:6px;
      padding:0.4rem;
    }
    .add-task-form button {
      background:#8b6d0c; color:#fff; border:none; border-radius:6px;
      padding:0.5rem 1rem; cursor:pointer;
    }
    .add-task-form button:hover {
      background:#b38b14;
    }

    /* ========== Emoji Lock Overlay ========== */
    .login-overlay {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5);
      display:flex; justify-content:center; align-items:center;
      z-index:999;
    }
    .login-box {
      background:#fffef6; border:2px dashed #d0bb8c; border-radius:10px;
      width:360px; padding:1rem; text-align:center; position:relative;
    }
    .login-box h3 {
      margin-bottom:0.5rem; color:#5c4b12; font-size:1.4rem;
    }
    .emoji-sequence {
      display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap;
      font-size:1.8rem; user-select:none; margin-top:1rem;
    }
    .emoji-sequence span {
      cursor:pointer; padding:0.2rem; transition:transform 0.2s;
    }
    .emoji-sequence span:hover { transform:scale(1.2); }

    /* ========== Time Rewind Expand Card ========== */
    .rewind-grid {
      margin-top:1rem;
      display:grid; grid-template-columns:1fr 1fr;
      gap:1rem;
    }
    .rewind-module {
      background:#fffef6; border:2px dashed #d0bb8c; border-radius:10px;
      padding:1rem;
    }
    .rewind-module h3 {
      font-size:1.2rem; color:#5c4b12; margin-bottom:0.5rem;
    }

    /* Responsive */
    @media(max-width:768px){
      .sidebar { width:180px; }
      .main-content { margin-left:180px; }
      .login-box { width:280px; }
      .emoji-sequence { font-size:1.6rem; }
      .rewind-grid {
        grid-template-columns:1fr; /* ÂçïÂàó */
      }
    }
  </style>
</head>
<body>
  <!-- Á≤íÂ≠êËÉåÊôØ -->
  <div id="particles-js"></div>

  <!-- Â∑¶‰æßÂØºËà™ -->
  <aside class="sidebar">
    <div class="title">Wizard Navigation</div>
    <ul class="nav-links">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="badge.html">Badge Room</a></li>
      <li><a href="wishmood.html">Wish & Mood</a></li>
      <li><a href="destiny.html">Destiny Room</a></li>
      <li><a href="owltower.html" class="active">Owl Tower</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="header-row">
      <h1 class="header-title">Boom Boom‚Äôs Owl Tower Console ü¶âüè∞</h1>
    </div>

    <!-- BoomBoom typed bar -->
    <div class="boom-bar">
      <div class="boom-avatar">
        <img src="assets/images/owl-hi.png" alt="BoomBoom" />
      </div>
      <div class="boom-text">
        <h2>Backend Management System</h2>
        <div class="typed-line" id="typedLine"></div>
      </div>
    </div>

    <!-- ÂêéÂè∞ÂØºËà™ÊåâÈíÆ -->
    <div class="backend-nav">
      <button id="btnShowTasks">Tasks & ToDos</button>
      <button>Badge & Fragments</button>
      <button>Wish & Mood</button>
      <button>Destiny Summer</button>
      <button id="btnShowRewind">Time Rewind</button>
    </div>

    <!-- 1) ToDo Expandable -->
    <div class="expandable-card" id="todoCard">
      <h2>
        To-Do List Editor
        <span class="arrow">‚ñ∂</span>
      </h2>
      <div class="content" id="todoContent">
        <div class="recommendation" id="moodRecommendation" style="display:none;">
          <strong>Low mood detected!</strong> Suggest easier tasks & fewer pushes.
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- Mandatory / Optional -->
        <div class="task-category">
          <h3>üìå Mandatory Tasks</h3>
          <ul id="mandList"></ul>
        </div>
        <div class="task-category">
          <h3>üéØ Optional Tasks</h3>
          <ul id="optList"></ul>
        </div>

        <!-- Editor Footer -->
        <div class="editor-footer">
          <form class="add-task-form" id="addTaskForm">
            <input type="text" id="taskTitle" placeholder="Task Title" />
            <select id="taskDiff">
              <option value="high">High</option>
              <option value="medium" selected>Medium</option>
              <option value="low">Low</option>
            </select>
            <select id="taskCat">
              <option value="mandatory">Mandatory</option>
              <option value="optional">Optional</option>
            </select>
            <label> Subtask?
              <input type="checkbox" id="hasSubtask" />
            </label>
            <button type="submit">Add Task</button>
          </form>

          <button id="btnExportCsv" style="margin-top:0.5rem;">Export CSV</button>
        </div>
      </div>
    </div>

    <!-- 2) Time Rewind Expandable, with 4 sub modules -->
    <div class="expandable-card" id="rewindCard" style="display:none;">
      <h2>
        Time Rewind
        <span class="arrow">‚ñ∂</span>
      </h2>
      <div class="content">
        <p>Rewind the timeline for different modules!</p>
        <div class="rewind-grid">
          <!-- 4 modules -->
          <div class="rewind-module" id="rwTodo">
            <h3>ToDoList Rewind</h3>
            <p>Undo missed tasks within 3 days, etc...</p>
          </div>
          <div class="rewind-module" id="rwBadge">
            <h3>Badge Rewind</h3>
            <p>Recalculate or revert badge awarding, etc...</p>
          </div>
          <div class="rewind-module" id="rwWish">
            <h3>Wish Rewind</h3>
            <p>Revert or re-queue wish requests...</p>
          </div>
          <div class="rewind-module" id="rwDestiny">
            <h3>Destiny Rewind</h3>
            <p>Undo destiny draws or re-activate them...</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Emoji Lock Overlay -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h3>Emoji Magic Lock</h3>
      <div class="emoji-sequence" id="emojiSeq"></div>
    </div>
  </div>

  <script>
    // 0) Particle BG
    particlesJS("particles-js", {
      "particles": {
        "number":{"value":50,"density":{"enable":true,"value_area":800}},
        "color":{"value":["#FFFBE6","#FFD700","#FFECB3"]},
        "shape":{"type":"star","stroke":{"width":0,"color":"#ffffff"}},
        "opacity":{"value":0.8,"random":true},
        "size":{"value":6,"random":true},
        "line_linked":{"enable":false},
        "move":{
          "enable":true,"speed":1.5,"direction":"none",
          "random":true,"straight":false,"out_mode":"out","bounce":false
        }
      },
      "interactivity":{
        "detect_on":"canvas",
        "events":{
          "onhover":{"enable":true,"mode":"repulse"},
          "onclick":{"enable":true,"mode":"push"}
        },
        "modes":{
          "repulse":{"distance":80,"duration":0.4},
          "push":{"particles_nb":3}
        }
      },
      "retina_detect":true
    });

    // 1) Typed line
    const typedEl=document.getElementById('typedLine');
    const typedArr=[
      "‚ÄúTwo main modules remain: ToDo Editor & Time Rewind!‚Äù",
      "‚ÄúEnjoy color-coded difficulties and subtask nesting!‚Äù"
    ];
    const line=typedArr[Math.floor(Math.random()*typedArr.length)];
    let i=0, spd=45;
    function typeIt(){
      if(i<line.length){
        typedEl.textContent+=line.charAt(i);
        i++;
        setTimeout(typeIt, spd);
      }
    }
    typeIt();

    // 2) Emoji Lock (6th)
    const lockOverlay=document.getElementById('loginOverlay');
    const seqEl=document.getElementById('emojiSeq');
    const emojis=["üå∏","üêô","ü™Ñ","üçé","ü¶â","üêõ","üßÅ","üé©","üê¨","üçÑ","üíé","üç≠","üçÄ","üêû","üåà","üí´","‚≠ê","üçã","üéÉ","ü™ê","‚ö°","ü§ñ","ü¶Ä","üéÅ","üëª","üç∞","üåª","üöÄ"];
    let randomArr=[];
    const correctIdx=5;
    (function genEmoji(){
      for(let j=0;j<10;j++){
        const rx=Math.floor(Math.random()*emojis.length);
        randomArr.push(emojis[rx]);
      }
      let h="";
      randomArr.forEach((em,i)=>{
        h+=`<span data-idx="${i}">${em}</span>`;
      });
      seqEl.innerHTML=h;
    })();
    seqEl.addEventListener('click',(e)=>{
      if(e.target.matches('span')){
        const idx=parseInt(e.target.dataset.idx);
        if(idx===correctIdx){
          lockOverlay.style.display='none';
        }
      }
    });

    // 3) Two expand-cards: ToDo & Rewind
    const todoCard=document.getElementById('todoCard');
    const rewindCard=document.getElementById('rewindCard');
    todoCard.addEventListener('click',(e)=>{
      if(e.target.tagName.toLowerCase()==='h2' || e.target.classList.contains('arrow')){
        todoCard.classList.toggle('expanded');
      }
    });
    rewindCard.addEventListener('click',(e)=>{
      if(e.target.tagName.toLowerCase()==='h2' || e.target.classList.contains('arrow')){
        rewindCard.classList.toggle('expanded');
      }
    });

    // 4) Hide Rewind Card by default, show/hide via button
    const btnShowTasks=document.getElementById('btnShowTasks');
    const btnShowRewind=document.getElementById('btnShowRewind');
    btnShowTasks.addEventListener('click',()=>{
      todoCard.style.display='block';
      rewindCard.style.display='none';
    });
    btnShowRewind.addEventListener('click',()=>{
      todoCard.style.display='none';
      rewindCard.style.display='block';
    });

    // ========== ToDo Logic ==========
    const moodRecEl=document.getElementById('moodRecommendation');
    let userMood=2; // if <3 => show
    if(userMood<3){
      moodRecEl.style.display='block';
    }

    const progressBar=document.getElementById('progressBar');
    const mandList=document.getElementById('mandList');
    const optList=document.getElementById('optList');

    const addTaskForm=document.getElementById('addTaskForm');
    const taskTitleEl=document.getElementById('taskTitle');
    const taskDiffEl=document.getElementById('taskDiff');
    const taskCatEl=document.getElementById('taskCat');
    const hasSubtaskEl=document.getElementById('hasSubtask');
    const btnExportCsv=document.getElementById('btnExportCsv');

    // demo tasks
    let tasks=[
      {
        id:101, text:"üìó ÈòÖËØª Harry Potter", difficulty:"high",
        type:"mandatory", done:false, consecutiveDays:1,
        subtasks:[{title:"Á¨¨1Â∞èËäÇ",done:false},{title:"Á¨¨2Â∞èËäÇ",done:true}]
      },
      {
        id:102, text:"‚úèÔ∏è ÂÜô5Âè•Â∞èÊó•Âøó", difficulty:"medium",
        type:"mandatory", done:false, consecutiveDays:2, subtasks:[]
      },
      {
        id:201, text:"üíª Âà∂‰ΩúScience Notebook", difficulty:"low",
        type:"optional", done:true, consecutiveDays:0, subtasks:[]
      }
    ];

    function renderTasks(){
      mandList.innerHTML='';
      optList.innerHTML='';

      // compute progress
      let total=tasks.length, doneCount=tasks.filter(t=>t.done).length;
      let rate=Math.floor((doneCount/total)*100);
      progressBar.style.width=rate+'%';

      tasks.forEach(task=>{
        const li=document.createElement('li');
        li.classList.add('task-item');

        // 1) push to Dashboard
        const pushBox=document.createElement('input');
        pushBox.type='checkbox';
        pushBox.classList.add('push-chk');
        pushBox.addEventListener('change',()=>{
          if(pushBox.checked){
            // store in localStorage
            let data=JSON.parse(localStorage.getItem('pushedTasks')||'[]');
            if(!data.find(dt=>dt.id===task.id)){
              data.push(task);
              localStorage.setItem('pushedTasks', JSON.stringify(data));
              alert(`Êé®ÈÄÅÂà∞Dashboard: ${task.text}`);
            }
          }
        });
        li.appendChild(pushBox);

        // 2) difficulty color
        const diffSpan=document.createElement('span');
        diffSpan.classList.add('diff-label');
        if(task.difficulty==='high') diffSpan.classList.add('diff-high');
        else if(task.difficulty==='medium') diffSpan.classList.add('diff-medium');
        else diffSpan.classList.add('diff-low');
        diffSpan.textContent=task.difficulty;
        li.appendChild(diffSpan);

        // 3) category
        const catSpan=document.createElement('span');
        catSpan.classList.add('cat-label');
        catSpan.textContent=task.type;
        li.appendChild(catSpan);

        // 4) done checkbox
        const doneChk=document.createElement('input');
        doneChk.type='checkbox';
        doneChk.checked=task.done;
        doneChk.addEventListener('change',()=>{
          task.done=doneChk.checked;
          if(task.done) task.consecutiveDays=0;
          renderTasks();
        });
        li.appendChild(doneChk);

        // 5) title
        const titleSpan=document.createElement('span');
        titleSpan.classList.add('task-text');
        titleSpan.textContent=task.text;
        li.appendChild(titleSpan);

        // 6) consecutive >=2 => highlight
        if(!task.done && task.consecutiveDays>=2){
          const hw=document.createElement('span');
          hw.classList.add('highlight-warning');
          hw.textContent="Êú™ÂÆåÊàê2+Â§©";
          li.appendChild(hw);
        }

        // 7) edit
        const editBtn=document.createElement('button');
        editBtn.textContent='Edit';
        editBtn.addEventListener('click',()=>{
          const nv=prompt("ÁºñËæë‰ªªÂä°Ôºö", task.text);
          if(nv && nv.trim()){
            task.text=nv.trim();
            renderTasks();
          }
        });
        li.appendChild(editBtn);

        // 8) del
        const delBtn=document.createElement('button');
        delBtn.textContent='Del'; delBtn.style.marginLeft='4px';
        delBtn.addEventListener('click',()=>{
          if(confirm("Á°ÆËÆ§Âà†Èô§Ôºü")){
            tasks=tasks.filter(t=>t.id!==task.id);
            renderTasks();
          }
        });
        li.appendChild(delBtn);

        // 9) subtask
        if(task.subtasks && task.subtasks.length>0){
          const ulSt=document.createElement('ul');
          ulSt.classList.add('subtask-list');
          task.subtasks.forEach(st=>{
            const liSt=document.createElement('li');
            liSt.classList.add('subtask-item');
            const stChk=document.createElement('input');
            stChk.type='checkbox';
            stChk.checked=st.done;
            stChk.addEventListener('change',()=>{
              st.done=stChk.checked;
              if(task.subtasks.every(s=>s.done)){
                task.done=true; task.consecutiveDays=0;
              } else {
                task.done=false;
              }
              renderTasks();
            });
            liSt.appendChild(stChk);
            const stSp=document.createElement('span');
            stSp.textContent=st.title;
            liSt.appendChild(stSp);
            ulSt.appendChild(liSt);
          });
          li.appendChild(ulSt);
        }

        if(task.type==='mandatory'){
          mandList.appendChild(li);
        } else {
          optList.appendChild(li);
        }
      });
    }
    renderTasks();

    // Êñ∞Â¢û‰ªªÂä°
    addTaskForm.addEventListener('submit',(e)=>{
      e.preventDefault();
      const txt=taskTitleEl.value.trim();
      const diff=taskDiffEl.value;
      const cat=taskCatEl.value;
      const sb=hasSubtaskEl.checked;
      if(!txt){
        alert("ËØ∑ËæìÂÖ•‰ªªÂä°Ê†áÈ¢ò");
        return;
      }
      const newId=Date.now();
      const newTask={
        id:newId,
        text:txt,
        difficulty:diff,
        type:cat,
        done:false,
        consecutiveDays:0,
        subtasks: sb? [
          {title:"Â≠ê‰ªªÂä°1",done:false},
          {title:"Â≠ê‰ªªÂä°2",done:false}
        ] : []
      };
      tasks.push(newTask);
      taskTitleEl.value='';
      hasSubtaskEl.checked=false;
      renderTasks();
    });

    // ÂØºÂá∫CSV (Â∏¶ÂΩìÊó•Êó•Êúü)
    btnExportCsv.addEventListener('click',()=>{
      const todayStr=new Date().toISOString().split('T')[0];
      let csv="id,text,difficulty,type,done,consecutiveDays,subtasks\n";
      tasks.forEach(t=>{
        let sub=(t.subtasks||[]).map(s=> s.title+(s.done?"(done)":"(no)")).join("|");
        let row=`${t.id},"${t.text.replace(/"/g,'""')}",${t.difficulty},${t.type},${t.done},${t.consecutiveDays},"${sub}"`;
        csv+=row+"\n";
      });
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const link=document.createElement('a');
      link.href=url;
      link.download=`tasks_${todayStr}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    });

  </script>
</body>
</html>
