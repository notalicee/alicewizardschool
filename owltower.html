<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Owl Tower Console</title>
  
  <!-- ÂºïÂÖ• Pangolin Â≠ó‰Ωì -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link 
    href="https://fonts.googleapis.com/css2?family=Pangolin&display=swap" 
    rel="stylesheet"
  >
  
  <!-- ÂºïÂÖ• particles.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <style>
    /* ========== Reset & Global ========== */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    body {
      display: flex;
      min-height: 100vh;
      font-family: 'Pangolin', cursive; 
      font-size: 18px;
      line-height: 1.6;
      color: #4d3b2f; /* Ê∑±Ê£ï */
      position: relative;
      overflow-x: hidden;  
    }
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
      background: #f6f2e7; /* Á≤íÂ≠êËÉåÊôØ */
    }

    a {
      text-decoration: none;
      color: inherit;
      transition: color 0.3s;
    }
    a:hover {
      color: #b38b14;
    }

    /* ========== Sidebar ========== */
    .sidebar {
      width: 220px;
      background: #3d3c2e;
      padding: 2rem 1rem;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      z-index: 10;
    }
    .sidebar .title {
      font-size: 2rem;
      margin-bottom: 2rem;
      color: #fce6c9;
      text-align: center;
    }
    .nav-links {
      list-style: none;
      font-size: 1.25rem;
    }
    .nav-links li {
      margin-bottom: 1.2rem;
    }
    .nav-links li a {
      color: #fce6c9;
      font-weight: bold;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      display: inline-block;
      transition: background 0.3s, color 0.3s;
    }
    .nav-links li a:hover {
      background: #b38b14; 
      color: #fff;
    }
    /* È´ò‰∫ÆÂΩìÂâçÈ°µÈù¢‚ÄúOwl Tower‚Äù */
    .active {
      background: #b38b14;
      color: #fff;
    }

    /* ========== Main Content ========== */
    .main-content {
      margin-left: 220px;
      flex: 1;
      padding: 2rem;
      position: relative;
      z-index: 10;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .header-title {
      font-size: 2rem;
      color: #b38b14; 
    }

    /* ========== BoomBoom's typed bar ========== */
    .boom-bar {
      background: #fff8e1;
      border: 2px dashed #b38b14;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .boom-avatar {
      width: 60px; height: 60px;
      border-radius: 50%;
      background-color: #fff3c1;
      overflow: hidden;
      flex-shrink: 0;
    }
    .boom-avatar img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .boom-text { flex: 1; }
    .boom-text h2 {
      font-size: 1.4rem; color: #8c6e0c; margin-bottom: 0.25rem;
    }
    .typed-line {
      color: #6b4b0c; font-size: 1rem; white-space: pre-wrap;
    }

    /* ========== Backend Navigation Bar ========== */
    .backend-nav {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .backend-nav button {
      background: #8b6d0c; color: #fff;
      border: none; border-radius: 6px; padding: 0.5rem 1rem;
      cursor: pointer;
    }
    .backend-nav button:hover { background: #b38b14; }

    /* ========== ToDo Expandable Card ========== */
    .expandable-card {
      background: #fffef6;
      border: 2px dashed #d0bb8c;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 1rem;
      transition: max-height 0.5s, padding 0.5s;
    }
    .expandable-card h2 {
      font-size: 1.3rem; color: #5c4b12; margin: 0;
      padding: 1rem; cursor: pointer; display: flex;
      align-items: center; justify-content: space-between;
    }
    .expandable-card h2:hover { background: #fff4c2; }
    .expandable-card .content {
      padding: 0 1rem; max-height: 0;
      overflow: hidden;
    }
    .expandable-card.expanded .content {
      max-height: 2000px; padding-bottom: 1rem;
    }
    .arrow {
      font-size: 1.2rem; transition: transform 0.3s;
    }
    .expanded .arrow { transform: rotate(90deg); }

    /* Recommendation, progress bar */
    .recommendation {
      margin: 0.5rem 0; padding: 0.4rem;
      border-left: 4px solid #f77;
      background: #fffaea;
    }
    .progress-bar-container {
      margin-top: 1rem; background: #eee; border-radius: 6px;
      overflow: hidden; height: 18px; width: 80%; max-width: 400px;
    }
    .progress-bar {
      height: 100%; background: #b38b14; width: 0%; transition: width 0.4s;
    }

    /* Task category & list */
    .task-category { margin-bottom: 1rem; }
    .task-category h3 {
      margin-bottom: 0.5rem; color: #b38b14; font-size: 1.1rem;
    }
    .task-category ul {
      list-style: none; margin-left: 1rem; padding-left: 0;
    }
    .task-item {
      display: flex; align-items: center;
      margin-bottom: 0.5rem; gap: 0.5rem;
    }
    .task-item span.task-text { flex:1; }
    .task-item button {
      background: #d8c593; border:none; border-radius:4px;
      padding: 0.3rem 0.5rem; cursor:pointer; color:#4d3b2f; font-size:0.9rem;
    }
    .task-item button:hover { background: #b9a377; }
    .highlight-warning {
      background: #ffe5e5; padding:0.2rem 0.4rem;
      border-radius:4px; margin-left:0.5rem; color:#c30;
    }

    /* Add Task Form */
    .add-task-form {
      margin-top:1rem; display:flex; gap:0.5rem;
      flex-wrap:wrap; align-items:center;
    }
    .add-task-form input[type="text"] {
      flex:1; padding:0.4rem; border:1px solid #ccc; border-radius:6px;
    }
    .add-task-form select {
      padding:0.4rem; border:1px solid #ccc; border-radius:6px;
    }
    .add-task-form button {
      background:#8b6d0c; color:#fff; border:none;
      padding:0.5rem 1rem; border-radius:6px; cursor:pointer;
    }
    .add-task-form button:hover { background:#b38b14; }

    /* Rewind / Sorting */
    .rewind-form, .sort-form {
      margin-top: 1rem; display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;
    }
    .rewind-form input[type="date"] {
      border:1px solid #ccc; border-radius:6px; padding:0.4rem;
    }

    /* Emoji Lock Overlay */
    .login-overlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      display: flex; justify-content:center; align-items:center;
      z-index:999;
    }
    .login-box {
      background: #fffef6; border:2px dashed #d0bb8c; border-radius:10px;
      width: 360px; padding:1rem; text-align:center; position:relative;
    }
    .login-box h3 {
      margin-bottom:0.5rem; color:#5c4b12; font-size:1.4rem;
    }
    .emoji-sequence {
      display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap;
      font-size:1.8rem; user-select:none; margin-top:1rem;
    }
    .emoji-sequence span {
      cursor:pointer; padding:0.2rem; transition:transform 0.2s;
    }
    .emoji-sequence span:hover { transform:scale(1.2); }

    /* Responsive */
    @media(max-width:768px){
      .sidebar { width:180px; }
      .main-content { margin-left:180px; }
      .login-box { width:280px; }
      .emoji-sequence { font-size:1.6rem; }
    }
  </style>
</head>
<body>
  <!-- Á≤íÂ≠êËÉåÊôØ -->
  <div id="particles-js"></div>

  <!-- Â∑¶‰æßÂØºËà™Ê†è -->
  <aside class="sidebar">
    <div class="title">Wizard Navigation</div>
    <ul class="nav-links">
      <!-- ÊåâÈúÄË¶ÅËÅîÂä® -->
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="badge.html">Badge Room</a></li>
      <li><a href="todo.html">To Do List</a></li>
      <li><a href="wishmood.html">Wish & Mood</a></li>
      <li><a href="destiny.html">Destiny Room</a></li>
      <li><a href="owltower.html" class="active">Owl Tower</a></li>
    </ul>
  </aside>

  <!-- Âè≥‰æß‰∏ªÂÜÖÂÆπ -->
  <main class="main-content">
    <div class="header-row">
      <h1 class="header-title">Boom Boom‚Äôs Owl Tower Console ü¶âüè∞</h1>
    </div>

    <!-- BoomBoom typed-line -->
    <div class="boom-bar">
      <div class="boom-avatar">
        <img src="assets/images/owl-hi.png" alt="Professor Boom Boom" />
      </div>
      <div class="boom-text">
        <h2>Backend Management System</h2>
        <div class="typed-line" id="boomLine"></div>
      </div>
    </div>

    <!-- ÂêéÂè∞Ê®™ÂêëÂØºËà™ -->
    <div class="backend-nav">
      <button>Tasks & ToDos</button>
      <button>Badge & Fragments</button>
      <button>Wish & Mood</button>
      <button>Destiny Summer</button>
      <button>Time Rewind</button>
    </div>

    <!-- Âè™‰øùÁïô‰∏Ä‰∏™Expand Card for ToDo Editor -->
    <div class="expandable-card" id="todoCard">
      <h2>
        To-Do List Editor
        <span class="arrow">‚ñ∂</span>
      </h2>
      <div class="content" id="todoContent">
        <!-- ‰ΩéÂøÉÊÉÖÊèêÁ§∫ -->
        <div class="recommendation" id="recommendationBar" style="display:none;">
          <strong>Low mood detected.</strong> Suggesting easy tasks.
        </div>

        <!-- ËøõÂ∫¶Êù° -->
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- ‰ªªÂä°ÂàÜÁ±ªÂ±ïÁ§∫ -->
        <div class="task-category">
          <h3>üìå Mandatory Tasks</h3>
          <ul id="mandatoryList"></ul>
        </div>
        <div class="task-category">
          <h3>üéØ Optional Tasks</h3>
          <ul id="optionalList"></ul>
        </div>

        <!-- Êñ∞Â¢û‰ªªÂä°Ë°®Âçï -->
        <form class="add-task-form" id="addTaskForm">
          <input type="text" id="taskInput" placeholder="Task description" />
          <select id="taskType">
            <option value="mandatory">Mandatory</option>
            <option value="optional">Optional</option>
          </select>
          <button type="submit">Add Task</button>
        </form>

        <!-- ÊéíÂ∫è‰∏ãÊãâ + ÊéíÂ∫èÊåâÈíÆ -->
        <div class="sort-form" id="sortForm">
          <label>Sort by:</label>
          <select id="sortSelect">
            <option value="none">None</option>
            <option value="type">Type</option>
            <option value="done">Done</option>
          </select>
          <button id="btnSort">Sort</button>
        </div>

        <!-- Ë°•ÁôªÂäüËÉΩ -->
        <div class="rewind-form" id="rewindForm">
          <label>Time Rewind:</label>
          <input type="date" id="rewindDate" />
          <input type="text" id="rewindDesc" placeholder="Backfill description" />
          <button id="btnRewind">Backfill</button>
        </div>

        <!-- ÂØºÂá∫CSV (Â∏¶ÂΩìÊó•Êó•Êúü) -->
        <button id="btnExportCsv" style="margin-top:1rem;">Export CSV</button>
      </div>
    </div>
  </main>

  <!-- ÁôªÂΩïÈÅÆÁΩ©: ÁÇπÂáªÁ¨¨6‰∏™emojiÊâçÂèØËøõÂÖ• -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h3>Emoji Magic Lock</h3>
      <div class="emoji-sequence" id="emojiSequence">
        <!-- jsÁîüÊàê10‰∏™ -->
      </div>
    </div>
  </div>

  <script>
    // 1) Á≤íÂ≠êÁâπÊïà
    particlesJS("particles-js", {
      "particles": {
        "number":{"value":50,"density":{"enable":true,"value_area":800}},
        "color":{"value":["#FFFBE6","#FFD700","#FFECB3"]},
        "shape":{
          "type":"star","stroke":{"width":0,"color":"#ffffff"}
        },
        "opacity":{"value":0.8,"random":true},
        "size":{"value":6,"random":true},
        "line_linked":{"enable":false},
        "move":{
          "enable":true,"speed":1.5,"direction":"none","random":true,
          "straight":false,"out_mode":"out","bounce":false
        }
      },
      "interactivity": {
        "detect_on":"canvas",
        "events":{
          "onhover":{"enable":true,"mode":"repulse"},
          "onclick":{"enable":true,"mode":"push"}
        },
        "modes":{
          "repulse":{"distance":80,"duration":0.4},
          "push":{"particles_nb":3}
        }
      },
      "retina_detect":true
    });

    // 2) BoomBoomÊâìÂ≠óÊú∫
    const boomLineEl = document.getElementById('boomLine');
    const typedLines = [
      "‚ÄúWelcome to the advanced Owl Tower console!‚Äù",
      "‚ÄúNo backend? No problem! CSV magic incantations!‚Äù",
      "‚ÄúRewind time, reduce consecutive days, reorder tasks!‚Äù",
      "‚ÄúYour tasks, your rules‚Äîjust a wand flick away!‚Äù"
    ];
    const chosenLine = typedLines[Math.floor(Math.random()*typedLines.length)];
    let idx=0, spd=40;
    function doTyping() {
      if(idx<chosenLine.length){
        boomLineEl.textContent += chosenLine.charAt(idx);
        idx++;
        setTimeout(doTyping, spd);
      }
    }
    doTyping();

    // 3) EmojiÈîÅ:Á¨¨6‰∏™Á¥¢Âºï=5
    const lockOverlay=document.getElementById('loginOverlay');
    const emojiSeqEl=document.getElementById('emojiSequence');
    const allEmojis=["üå∏","üêô","ü™Ñ","üçé","ü¶â","üêõ","üßÅ","üé©","üê¨","üçÑ","üíé","üç≠","üçÄ","üêû","üåà","üí´","‚≠ê","üçã","üéÉ","ü™ê","‚ö°","ü§ñ","ü¶Ä","üéÅ","üëª","üç∞","üåª","üöÄ"];
    let randomArr=[];
    const correctEmojiIndex=5;
    (function genEmojis(){
      for(let i=0;i<10;i++){
        const rdx=Math.floor(Math.random()*allEmojis.length);
        randomArr.push(allEmojis[rdx]);
      }
      let html="";
      randomArr.forEach((em,i)=>{
        html+=`<span data-idx="${i}">${em}</span>`;
      });
      emojiSeqEl.innerHTML=html;
    })();
    emojiSeqEl.addEventListener('click',(e)=>{
      if(e.target.matches('span')){
        const i=parseInt(e.target.dataset.idx);
        if(i===correctEmojiIndex){
          lockOverlay.style.display='none';
        }
      }
    });

    // 4) Expandable ToDo Editor
    const todoCard=document.getElementById('todoCard');
    todoCard.addEventListener('click',(e)=>{
      if(e.target.tagName.toLowerCase()==='h2' || e.target.classList.contains('arrow')){
        todoCard.classList.toggle('expanded');
      }
    });

    // 5) ToDo Logic
    const recommendationBar=document.getElementById('recommendationBar');
    const progressBarEl=document.getElementById('progressBar');
    const mandatoryListEl=document.getElementById('mandatoryList');
    const optionalListEl=document.getElementById('optionalList');
    const addTaskForm=document.getElementById('addTaskForm');
    const taskInputEl=document.getElementById('taskInput');
    const taskTypeEl=document.getElementById('taskType');
    const btnSort=document.getElementById('btnSort');
    const sortSelect=document.getElementById('sortSelect');
    const rewindDateEl=document.getElementById('rewindDate');
    const rewindDescEl=document.getElementById('rewindDesc');
    const btnRewind=document.getElementById('btnRewind');
    const btnExportCsv=document.getElementById('btnExportCsv');

    // ÂÅáËÆæ mood=2 => ‰ΩéÊèêÁ§∫
    let userMood=2;
    if(userMood<3){
      recommendationBar.style.display='block';
    }

    // Á§∫‰æã tasks
    let tasks=[
      { id:101, text:"üìó ÈòÖËØª Harry Potter", type:"mandatory", done:false, consecutiveNotDoneDays:1 },
      { id:102, text:"üìò ÂÆåÊàê 1 ‰∏™ IXL", type:"mandatory", done:false, consecutiveNotDoneDays:2 },
      { id:201, text:"üé® Procreate Âàõ‰Ωú", type:"optional", done:false, consecutiveNotDoneDays:0 },
      { id:202, text:"üíª ÂÅöScience Notebook", type:"optional", done:true, consecutiveNotDoneDays:0 },
    ];

    function renderTasks(){
      mandatoryListEl.innerHTML='';
      optionalListEl.innerHTML='';

      // ËÆ°ÁÆóËøõÂ∫¶
      const total=tasks.length;
      const doneCount=tasks.filter(t=>t.done).length;
      const rate=Math.floor((doneCount/total)*100);
      progressBarEl.style.width=rate+'%';

      tasks.forEach(task=>{
        const li=document.createElement('li');
        li.classList.add('task-item');

        const cb=document.createElement('input');
        cb.type='checkbox'; cb.checked=task.done;
        cb.addEventListener('change',()=>{
          task.done=cb.checked;
          // Ëã•done => consecutive=0
          if(task.done) task.consecutiveNotDoneDays=0;
          renderTasks();
        });
        li.appendChild(cb);

        const sp=document.createElement('span');
        sp.classList.add('task-text');
        sp.textContent=task.text;
        li.appendChild(sp);

        // ËøûÁª≠Êú™ÂÆåÊàê>=2 =>È´ò‰∫Æ
        if(!task.done && task.consecutiveNotDoneDays>=2){
          const hw=document.createElement('span');
          hw.classList.add('highlight-warning');
          hw.textContent="Êú™ÂÆåÊàê2+Â§©";
          li.appendChild(hw);
        }

        // Edit
        const editBtn=document.createElement('button');
        editBtn.textContent='Edit';
        editBtn.addEventListener('click',()=>{
          const nv=prompt("ÁºñËæë‰ªªÂä°Ôºö",task.text);
          if(nv && nv.trim()){
            task.text=nv.trim();
            renderTasks();
          }
        });
        li.appendChild(editBtn);

        // Del
        const delBtn=document.createElement('button');
        delBtn.textContent='Del';
        delBtn.style.marginLeft='4px';
        delBtn.addEventListener('click',()=>{
          if(confirm("Á°ÆËÆ§Âà†Èô§Ôºü")){
            tasks=tasks.filter(t=>t.id!==task.id);
            renderTasks();
          }
        });
        li.appendChild(delBtn);

        // ÂàÜÁ±ªÊòæÁ§∫
        if(task.type==='mandatory'){
          mandatoryListEl.appendChild(li);
        } else {
          optionalListEl.appendChild(li);
        }
      });
    }
    renderTasks();

    // Êñ∞Â¢û‰ªªÂä°
    addTaskForm.addEventListener('submit',(e)=>{
      e.preventDefault();
      const txt=taskInputEl.value.trim();
      const ttype=taskTypeEl.value;
      if(!txt){
        alert("ËØ∑ËæìÂÖ•‰ªªÂä°ÊèèËø∞");
        return;
      }
      const newId=Date.now();
      tasks.push({
        id:newId,
        text:txt,
        type:ttype,
        done:false,
        consecutiveNotDoneDays:0
      });
      taskInputEl.value='';
      renderTasks();
    });

    // ÊéíÂ∫è
    btnSort.addEventListener('click',()=>{
      const mode=sortSelect.value;
      if(mode==='type'){
        // mandatoryÊéíÂâç,optionalÊéíÂêé
        tasks.sort((a,b)=>{
          if(a.type===b.type) return 0;
          return a.type==='mandatory'?-1:1;
        });
      } else if(mode==='done'){
        // Êú™ÂÆåÊàêÊéíÂâç
        tasks.sort((a,b)=> Number(a.done)-Number(b.done));
      } else {
        // none
      }
      renderTasks();
    });

    // Ë°•Áôª (Time Rewind)
    btnRewind.addEventListener('click',()=>{
      const dateVal=rewindDateEl.value;
      const descVal=rewindDescEl.value.trim();
      if(!dateVal){
        alert("ËØ∑ÈÄâÊã©Êó•Êúü");
        return;
      }
      // Á§∫‰æãÈÄªËæëÔºöÂ∞ÜÊâÄÊúâÊú™ÂÆåÊàêÁöÑ consecutiveNotDoneDays=0
      tasks.forEach(t=>{
        if(!t.done && t.consecutiveNotDoneDays>0){
          t.consecutiveNotDoneDays=0;
        }
      });
      alert(`Ë°•ÁôªÊàêÂäü: ${descVal} @${dateVal}`);
      rewindDateEl.value='';
      rewindDescEl.value='';
      renderTasks();
    });

    // ÂØºÂá∫CSV(Â∏¶‰ªäÊó•Êó•Êúü)
    btnExportCsv.addEventListener('click',()=>{
      const todayStr=new Date().toISOString().split('T')[0];
      let csv="id,text,type,done,consecutiveNotDoneDays\n";
      tasks.forEach(t=>{
        const row=`${t.id},"${t.text.replace(/"/g,'""')}",${t.type},${t.done},${t.consecutiveNotDoneDays}`;
        csv+=row+"\n";
      });
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const link=document.createElement('a');
      link.href=url;
      link.download=`tasks_${todayStr}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
