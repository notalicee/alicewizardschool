<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Owl Tower Console</title>
  
  <!-- ÂºïÂÖ• Pangolin Â≠ó‰Ωì -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link 
    href="https://fonts.googleapis.com/css2?family=Pangolin&display=swap" 
    rel="stylesheet"
  >
  
  <!-- ÂºïÂÖ• particles.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <style>
    /* ========== Reset & Global ========== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      display: flex;
      min-height: 100vh;
      font-family: 'Pangolin', cursive; 
      font-size: 18px;
      line-height: 1.6;
      color: #4d3b2f; /* Ê∑±Ê£ï */
      position: relative;
      overflow-x: hidden;  
    }
    #particles-js {
      position: fixed; width: 100%; height: 100%;
      top: 0; left: 0; z-index: -1;
      background: #f6f2e7;
    }

    a { text-decoration: none; color: inherit; transition: color 0.3s; }
    a:hover { color: #b38b14; }

    /* ========== Sidebar ========== */
    .sidebar {
      width: 220px; background: #3d3c2e; padding: 2rem 1rem;
      position: fixed; top: 0; bottom: 0; left: 0;
      display: flex; flex-direction: column; z-index: 10;
    }
    .sidebar .title {
      font-size: 2rem; margin-bottom: 2rem;
      color: #fce6c9; text-align: center;
    }
    .nav-links { list-style: none; font-size: 1.25rem; }
    .nav-links li { margin-bottom: 1.2rem; }
    .nav-links li a {
      color: #fce6c9; font-weight: bold;
      padding: 0.4rem 0.6rem; border-radius: 6px;
      display: inline-block; transition: background 0.3s, color 0.3s;
    }
    .nav-links li a:hover {
      background: #b38b14; color: #fff;
    }
    .active {
      background: #b38b14; color: #fff;
    }

    /* ========== Main Content ========== */
    .main-content {
      margin-left: 220px; flex: 1; padding: 2rem;
      position: relative; z-index: 10;
    }
    .header-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1rem;
    }
    .header-title {
      font-size: 2rem; color: #b38b14; 
    }

    /* ========== BoomBoom's typed bar ========== */
    .boom-bar {
      background: #fff8e1; 
      border: 2px dashed #b38b14;
      border-radius: 10px;
      padding: 1rem; margin-bottom: 1rem;
      display: flex; align-items: center; gap: 1rem;
    }
    .boom-avatar {
      width: 60px; height: 60px; border-radius: 50%;
      background-color: #fff3c1; overflow: hidden; flex-shrink: 0;
    }
    .boom-avatar img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .boom-text { flex: 1; }
    .boom-text h2 {
      font-size: 1.4rem; color: #8c6e0c; margin-bottom: 0.25rem;
    }
    .typed-line {
      color: #6b4b0c; font-size: 1rem; white-space: pre-wrap;
    }

    /* ========== Backend Navigation Bar (Horizontal) ========== */
    .backend-nav {
      display: flex; gap: 1rem; margin-bottom: 1rem;
    }
    .backend-nav button {
      background: #8b6d0c; color: #fff; border: none; border-radius: 6px;
      padding: 0.5rem 1rem; cursor: pointer;
    }
    .backend-nav button:hover { background: #b38b14; }

    /* ========== Expandable Card for ToDo ========== */
    .expandable-card {
      background: #fffef6;
      border: 2px dashed #d0bb8c;
      border-radius: 10px;
      margin-bottom: 1rem;
      overflow: hidden;
      transition: max-height 0.5s, padding 0.5s;
    }
    .expandable-card h2 {
      font-size: 1.3rem; color: #5c4b12; margin: 0;
      padding: 1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: space-between;
    }
    .expandable-card h2:hover { background: #fff4c2; }
    .expandable-card .content {
      padding: 0 1rem; max-height: 0; overflow: hidden;
    }
    .expandable-card.expanded .content {
      max-height: 2000px; padding-bottom: 1rem;
    }
    .arrow {
      font-size: 1.2rem; transition: transform 0.3s;
    }
    .expanded .arrow {
      transform: rotate(90deg);
    }

    /* ========== ToDo & CSV Features ========== */
    .recommendation {
      margin: 0.5rem 0; padding: 0.4rem;
      border-left: 4px solid #f77;
      background: #fffaea;
    }
    .progress-bar-container {
      margin-top: 1rem; background: #eee; border-radius: 6px;
      overflow: hidden; height: 18px; width: 80%; max-width: 400px;
    }
    .progress-bar {
      height: 100%; background: #b38b14; width: 0%; transition: width 0.4s;
    }
    .task-category { margin-bottom: 1rem; }
    .task-category h3 {
      margin-bottom: 0.5rem; color: #b38b14; font-size: 1.1rem;
    }
    .task-category ul {
      list-style: none; margin-left: 1rem; padding-left: 0;
    }
    .task-item {
      display: flex; align-items: center; margin-bottom: 0.5rem; gap: 0.5rem;
    }
    .task-item span.task-text { flex: 1; }
    .task-item button {
      background: #d8c593; border: none; border-radius: 4px;
      padding: 0.3rem 0.5rem; cursor: pointer;
      color: #4d3b2f; font-size: 0.9rem;
    }
    .task-item button:hover { background: #b9a377; }
    .highlight-warning {
      background: #ffe5e5; 
      padding: 0.2rem 0.4rem; border-radius: 4px; margin-left: 0.5rem;
      color: #c30;
    }
    /* Ë°•ÁôªÂäüËÉΩ */
    .rewind-form {
      margin-top: 0.5rem;
    }
    .rewind-form input[type="date"] {
      padding: 0.3rem; border: 1px solid #ccc; border-radius: 6px;
    }
    .rewind-form button {
      background: #8b6d0c; color: #fff; border: none; border-radius: 6px;
      padding: 0.4rem 0.8rem; margin-left: 0.3rem; cursor: pointer;
    }
    .rewind-form button:hover {
      background: #b38b14;
    }

    /* ========== Emoji Password Magic Overlay ========== */
    .login-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex; justify-content: center; align-items: center;
      z-index: 999;
    }
    .login-box {
      background: #fffef6; border: 2px dashed #d0bb8c; border-radius: 10px;
      width: 360px; padding: 1rem; text-align: center; position: relative;
    }
    .login-box h3 {
      margin-bottom: 0.5rem; color: #5c4b12; font-size: 1.4rem;
    }
    .emoji-sequence {
      display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;
      font-size: 1.8rem; user-select: none; margin-top: 1rem;
    }
    .emoji-sequence span {
      cursor: pointer; padding: 0.2rem; transition: transform 0.2s;
    }
    .emoji-sequence span:hover {
      transform: scale(1.2);
    }

    /* Responsive */
    @media(max-width: 768px) {
      .sidebar { width: 180px; }
      .main-content { margin-left: 180px; }
      .login-box { width: 280px; }
      .emoji-sequence { font-size: 1.6rem; }
    }
  </style>
</head>
<body>

  <div id="particles-js"></div>

  <!-- ‰æßËæπÊ†è -->
  <aside class="sidebar">
    <div class="title">Wizard Navigation</div>
    <ul class="nav-links">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="#">Badge Room</a></li>
      <li><a href="#">To Do List</a></li>
      <li><a href="#">Wish & Mood</a></li>
      <li><a href="#">Destiny Room</a></li>
      <li><a href="owltower.html" class="active">Owl Tower</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="header-row">
      <h1 class="header-title">Boom Boom‚Äôs Owl Tower Console ü¶âüè∞</h1>
    </div>

    <!-- Boom Boom Banner -->
    <div class="boom-bar">
      <div class="boom-avatar">
        <img src="assets/images/owl-hi.png" alt="Professor Boom Boom" />
      </div>
      <div class="boom-text">
        <h2>Backend Management System</h2>
        <div class="typed-line" id="boomBoomLine"></div>
      </div>
    </div>

    <!-- ÂêéÂè∞ÂØºËà™ÔºàÊ®™ÊéíÊåâÈíÆÔºâ -->
    <div class="backend-nav">
      <button>Tasks & ToDos</button>
      <button>Badge & Fragments</button>
      <button>Wish & Mood</button>
      <button>Destiny Summer</button>
      <button>Time Rewind</button>
    </div>

    <!-- Â±ïÂºÄÂç°Áâá: ToDo List + CSV + Ë°•Áôª -->
    <div class="expandable-card" id="todoCard">
      <h2>
        To-Do List Editor
        <span class="arrow">‚ñ∂</span>
      </h2>
      <div class="content" id="todoContent">
        <div class="recommendation" id="moodRecommendation" style="display:none;">
          <strong>Low mood detected.</strong> System suggests easier tasks and reduces push notifications.
        </div>

        <div class="progress-bar-container">
          <div class="progress-bar" id="taskProgressBar"></div>
        </div>

        <!-- Mandatory / Optional ÂàÜÁ±ª -->
        <div class="task-category">
          <h3>üìå Mandatory Tasks</h3>
          <ul id="mandatoryList"></ul>
        </div>
        <div class="task-category">
          <h3>üéØ Optional Tasks</h3>
          <ul id="optionalList"></ul>
        </div>

        <!-- Êñ∞Â¢û‰ªªÂä°Ë°®Âçï -->
        <form class="add-task-form" id="addTaskForm">
          <input type="text" id="taskText" placeholder="Task description" />
          <select id="taskType">
            <option value="mandatory">Mandatory</option>
            <option value="optional">Optional</option>
          </select>
          <button type="submit">Add Task</button>
        </form>

        <!-- Ë°•ÁôªÂäüËÉΩ -->
        <div class="rewind-form" id="rewindSection">
          <label>Time Rewind:</label>
          <input type="date" id="rewindDate" />
          <button id="btnRewind">Backfill</button>
        </div>

        <!-- ÂØºÂá∫CSVÊåâÈíÆ -->
        <button id="btnExportCsv" style="margin-top:1rem;">Export ToDo as CSV</button>
      </div>
    </div>
  </main>

  <!-- ÁôªÂΩïÈÅÆÁΩ©: ÁÇπÂáªÁ¨¨6‰∏™emojiÊâçËøõÂÖ• -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h3>Emoji Magic Lock</h3>
      <div class="emoji-sequence" id="emojiSequence">
        <!-- 10‰∏™ÈöèÊú∫emoji -->
      </div>
    </div>
  </div>

  <script>
    // 1. Particles
    particlesJS("particles-js", {
      "particles": {
        "number": {"value":50,"density":{"enable":true,"value_area":800}},
        "color": {"value":["#FFFBE6","#FFD700","#FFECB3"]},
        "shape": {
          "type":"star","stroke":{"width":0,"color":"#ffffff"}
        },
        "opacity":{"value":0.8,"random":true},
        "size":{"value":6,"random":true},
        "line_linked":{"enable":false},
        "move":{
          "enable":true,"speed":1.5,"direction":"none","random":true,
          "straight":false,"out_mode":"out","bounce":false
        }
      },
      "interactivity": {
        "detect_on":"canvas",
        "events": {
          "onhover":{"enable":true,"mode":"repulse"},
          "onclick":{"enable":true,"mode":"push"}
        },
        "modes":{
          "repulse":{"distance":80,"duration":0.4},
          "push":{"particles_nb":3}
        }
      },
      "retina_detect":true
    });

    // 2. Typed line from Boom Boom
    const typedLineEl = document.getElementById('boomBoomLine');
    const lines = [
      "‚ÄúWelcome to the tower‚Äîwhere tasks become magical spells!‚Äù",
      "‚ÄúCSV incantations are mightier than JSON illusions!‚Äù",
      "‚ÄúYour broom is waiting‚Äîdo the chores or get flying!‚Äù",
      "‚ÄúFlick your wand, conjure your tasks, then export them!‚Äù"
    ];
    const line = lines[Math.floor(Math.random()*lines.length)];
    let i=0, speed=40;
    function typeWriter(){
      if(i<line.length){
        typedLineEl.textContent += line.charAt(i);
        i++;
        setTimeout(typeWriter, speed);
      }
    }
    typeWriter();

    // 3. Emoji Lock: click 6th => unlock
    const loginOverlay = document.getElementById('loginOverlay');
    const emojiSequenceEl = document.getElementById('emojiSequence');
    const emojis = ["üå∏","üêô","ü™Ñ","üçé","ü¶â","üêõ","üßÅ","üé©","üê¨","üçÑ","üíé","üç≠",
                    "üçÄ","üêû","üåà","üí´","‚≠ê","üçã","üéÉ","ü™ê","‚ö°","ü§ñ","ü¶Ä","üéÅ",
                    "üëª","üç∞","üåª","üöÄ"];
    let randomEmojis = [];
    const correctIndex = 5;

    (function genEmojis(){
      for(let j=0;j<10;j++){
        const idx = Math.floor(Math.random()*emojis.length);
        randomEmojis.push(emojis[idx]);
      }
      let html="";
      randomEmojis.forEach((em,i)=>{
        html += `<span data-index="${i}">${em}</span>`;
      });
      emojiSequenceEl.innerHTML = html;
    })();
    emojiSequenceEl.addEventListener('click', (e)=>{
      if(e.target.matches('span')){
        const index = parseInt(e.target.dataset.index);
        if(index===correctIndex){
          loginOverlay.style.display='none';
        }
      }
    });

    // 4. ToDo Data + Render
    const moodRecommendationEl = document.getElementById('moodRecommendation');
    const taskProgressBarEl = document.getElementById('taskProgressBar');
    const mandatoryListEl = document.getElementById('mandatoryList');
    const optionalListEl = document.getElementById('optionalList');
    const addTaskForm = document.getElementById('addTaskForm');
    const taskTextInput = document.getElementById('taskText');
    const taskTypeSelect = document.getElementById('taskType');
    const rewindDateEl = document.getElementById('rewindDate');
    const btnRewind = document.getElementById('btnRewind');
    const btnExportCsv = document.getElementById('btnExportCsv');

    // Demo: mood<3 => show recommendation
    let userMood = 2;
    if(userMood<3){
      moodRecommendationEl.style.display='block';
    }

    // Demo tasks
    let tasks = [
      { id:101, text:"üìó ÈòÖËØª Harry Potter Ëá≥Â∞ëÂçäÁ´†", type:"mandatory", done:false, consecutiveNotDoneDays:0},
      { id:102, text:"üìò ÂÆåÊàê1‰∏™ IXL‰ªªÂä°", type:"mandatory", done:true, consecutiveNotDoneDays:0},
      { id:103, text:"‚úèÔ∏è ÂÜô5Âè•Â∞èÊó•Âøó", type:"mandatory", done:false, consecutiveNotDoneDays:2},
      { id:201, text:"üé® Procreate Âàõ‰ΩúÂõæ + ÈÖçÂõæÂè•", type:"optional", done:false, consecutiveNotDoneDays:1},
      { id:202, text:"üíª Âà∂‰Ωú Science Notebook ÂÜÖÂÆπÈ°µ", type:"optional", done:false, consecutiveNotDoneDays:0},
      { id:203, text:"üíÉ ËøêÂä®15ÂàÜÈíü", type:"optional", done:false, consecutiveNotDoneDays:0},
    ];

    // Ê∏≤Êüì
    function renderTasks(){
      mandatoryListEl.innerHTML='';
      optionalListEl.innerHTML='';

      // ËÆ°ÁÆóÂÆåÊàêÁéá
      const total=tasks.length;
      const doneCount=tasks.filter(t=>t.done).length;
      const rate=Math.floor((doneCount/total)*100);
      taskProgressBarEl.style.width=rate+'%';

      tasks.forEach(task=>{
        const li=document.createElement('li');
        li.classList.add('task-item');

        // checkbox
        const checkbox=document.createElement('input');
        checkbox.type='checkbox';
        checkbox.checked=task.done;
        checkbox.addEventListener('change',()=>{
          task.done=checkbox.checked;
          renderTasks();
        });
        li.appendChild(checkbox);

        // text
        const spanText=document.createElement('span');
        spanText.classList.add('task-text');
        spanText.textContent=task.text;
        li.appendChild(spanText);

        // highlight if consecutive >=2
        if(!task.done && task.consecutiveNotDoneDays>=2){
          const warn=document.createElement('span');
          warn.classList.add('highlight-warning');
          warn.textContent='Êú™ÂÆåÊàê2+Â§©';
          li.appendChild(warn);
        }

        // edit
        const editBtn=document.createElement('button');
        editBtn.textContent='Edit';
        editBtn.addEventListener('click',()=>{
          const newVal=prompt("ÁºñËæë‰ªªÂä°Ôºö",task.text);
          if(newVal && newVal.trim()){
            task.text=newVal.trim();
            renderTasks();
          }
        });
        li.appendChild(editBtn);

        // del
        const delBtn=document.createElement('button');
        delBtn.textContent='Del';
        delBtn.style.marginLeft='4px';
        delBtn.addEventListener('click',()=>{
          if(confirm("Á°ÆËÆ§Âà†Èô§Ôºü")){
            tasks=tasks.filter(t=>t.id!==task.id);
            renderTasks();
          }
        });
        li.appendChild(delBtn);

        if(task.type==='mandatory'){
          mandatoryListEl.appendChild(li);
        } else {
          optionalListEl.appendChild(li);
        }
      });
    }
    renderTasks();

    // Êñ∞Â¢û‰ªªÂä°
    addTaskForm.addEventListener('submit',(e)=>{
      e.preventDefault();
      const txt=taskTextInput.value.trim();
      const ttype=taskTypeSelect.value;
      if(!txt){alert("ËØ∑ËæìÂÖ•‰ªªÂä°ÊèèËø∞"); return;}
      const newId=Date.now();
      tasks.push({
        id:newId, text:txt, type:ttype, done:false, consecutiveNotDoneDays:0
      });
      taskTextInput.value='';
      renderTasks();
    });

    // Ë°•Áôª(Backfill)ÂäüËÉΩ
    btnRewind.addEventListener('click',()=>{
      const dateVal=rewindDateEl.value;
      if(!dateVal){
        alert("ËØ∑ÈÄâÊã©‰∏Ä‰∏™Êó•ÊúüËøõË°åË°•Áôª");
        return;
      }
      // Âú®Ê≠§ÂÆûÁé∞ÂÖ∑‰ΩìÈÄªËæëÔºåÊØîÂ¶ÇËá™Âä®Ê∑ªÂä†‰∏ÄÊù°‚ÄúË°•ÁôªÔºöÊó•Êúü+‰ªªÂä°‚ÄùÔºåÊàñÁºñËæë consecutiveNotDoneDays
      // ËøôÈáå‰ªÖÊºîÁ§∫ÁÆÄÂçïpush
      const newId=Date.now();
      tasks.push({
        id:newId,
        text:`[Ë°•Áôª] ‰ªªÂä°‰∫é ${dateVal}`,
        type:"mandatory",
        done:false,
        consecutiveNotDoneDays:0
      });
      rewindDateEl.value='';
      renderTasks();
      alert("Ë°•Áôª‰ªªÂä°Â∑≤Ê∑ªÂä†");
    });

    // ÂØºÂá∫CSV(Â∏¶ÂΩìÊó•Êó•Êúü)
    btnExportCsv.addEventListener('click',()=>{
      const todayStr = new Date().toISOString().split('T')[0]; 
        // ‰æãÂ¶Ç "2025-06-11"
      let csvContent="id,text,type,done,consecutiveNotDoneDays\n";
      tasks.forEach(t=>{
        const row = `${t.id},"${t.text.replace(/"/g,'""')}",${t.type},${t.done},${t.consecutiveNotDoneDays}`;
        csvContent+=row+"\n";
      });

      const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);

      const link=document.createElement('a');
      link.href=url;
      link.download=`tasks_${todayStr}.csv`; 
      link.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
