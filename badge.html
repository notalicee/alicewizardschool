<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Badge Room</title>

  <!-- Pangolin Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pangolin&display=swap" rel="stylesheet">

  <!-- 粒子特效 -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <!-- ★ 与 Dashboard/Owl Tower 共用的全局样式 -->
  <link rel="stylesheet" href="style.css" />

  <!-- 本页专属微调 -->
  <style>
    /* ① 让粒子背景在底层且不吃点击 */
    #particles-js{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;pointer-events:none;}

    /* Tab 可见性 */
    .tab-content{display:none;}
    .tab-content.active{display:block;}

    /* Backend Nav */
    .backend-nav{display:flex;gap:1rem;margin-bottom:1rem;}
    .backend-nav button{
      background:#8b6d0c;color:#fff;border:none;padding:0.5rem 1rem;border-radius:6px;cursor:pointer;
      transition:background .2s;
    }
    .backend-nav button:hover{background:#b38b14;}
    .backend-nav button.active{box-shadow:0 0 0 2px #f7e3b2 inset;}

    /* Home 栅格 */
    .home-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;}
    @media(max-width:600px){.home-grid{grid-template-columns:1fr;}}

    /* 表格 */
    table{width:100%;border-collapse:collapse;font-size:0.95rem;}
    th,td{border:1px solid #e0c990;padding:0.45rem 0.6rem;text-align:center;}
    th{background:#f7e3b2;color:#8b6d0c;}

    /* 进度条 */
    .progress-wrap{margin-top:0.5rem;background:#f0e6d0;border-radius:6px;height:12px;overflow:hidden;}
    .progress-inner{height:100%;background:#b38b14;width:0%;transition:width .4s;}

    /* Badge 图鉴 hover */
    .badge-item{display:inline-block;width:48px;height:48px;line-height:48px;text-align:center;
      border:1px solid #d6c28c;margin:4px;cursor:pointer;border-radius:6px;transition:transform .2s,box-shadow .2s;}
    .badge-item:hover{transform:scale(1.15);box-shadow:0 0 10px 4px rgba(255,223,120,.8);}

    /* Fragment 滚动区 */
    .frag-log{max-height:180px;overflow-y:auto;}
  </style>
</head>
<body>
  <!-- 粒子背景 -->
  <div id="particles-js"></div>

  <aside class="sidebar">
    <div class="title">Wizard Navigation</div>
    <ul class="nav-links">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="#" class="active">Badge Room</a></li>
      <li><a href="todo.html">To Do List</a></li>
      <li><a href="wish.html">Wish & Mood</a></li>
      <li><a href="destiny.html">Destiny Room</a></li>
      <li><a href="owltower.html">Owl Tower</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="header-row"><h1 class="header-title">Badge Room</h1></div>

    <!-- BoomBoom Panel -->
    <div class="boom-panel">
      <div class="boom-avatar"><img src="assets/images/owl-star.png" alt="BoomBoom Owl"></div>
      <div class="boom-text">
        <h2>Welcome to Badge Room!</h2>
        <p id="todayInfo" style="font-size:1rem;margin-bottom:0.5rem;"></p>
        <div class="typed-line" id="boomBoomLine"></div>
      </div>
    </div>

    <!-- Backend Nav -->
    <div class="backend-nav">
      <button id="btnHome" class="active">Home</button>
      <button id="btnLibrary">Badge&nbsp;Library</button>
      <button id="btnFragment">Fragment</button>
      <button id="btnAchievement">Achievement&nbsp;Wall</button>
    </div>

    <!-- ① HOME -->
    <section id="tabHome" class="tab-content active">
      <div class="home-grid">
        <!-- 徽章统计 -->
        <div class="card">
          <h2>📊 Badge Overview</h2>
          <p>Total badges: <strong id="statTotal">0</strong></p>
          <p>Types collected: <strong id="statTypes">0</strong> / 20</p>
          <div class="progress-wrap"><div id="badgeProgress" class="progress-inner"></div></div>
          <p style="margin-top:0.4rem;">Rank: <strong id="statRank">Apprentice</strong></p>
        </div>

        <!-- 徽章登记 -->
        <div class="card">
          <h2>✍️ Badge Log</h2>
          <form id="badgeForm" style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.8rem;">
            <input type="date"   id="bDate" required>
            <input type="text"   id="bName"   placeholder="Name"   required>
            <input type="text"   id="bReason" placeholder="Reason" required>
            <input type="number" id="bQty"    placeholder="Qty"   min="1" required style="width:70px;">
            <input type="number" id="bTotal"  placeholder="Total" min="0" required style="width:85px;">
            <button type="submit">Log</button>
          </form>
          <button id="exportCsvBtn" style="margin-bottom:0.5rem;">Export CSV</button>
          <table id="badgeTable"><thead><tr><th>Date</th><th>Name</th><th>Reason</th><th>Qty</th><th>Total</th></tr></thead><tbody></tbody></table>
        </div>

        <!-- 即将获得提醒 -->
        <div class="card">
          <h2>🔔 Almost There!</h2>
          <div style="display:flex;gap:0.5rem;"><img src="assets/images/head.png" alt="Boom" style="width:36px;height:36px;">
            <ul id="reminderList" style="list-style:inside;margin:0;padding-left:0.2rem;"></ul>
          </div>
        </div>

        <!-- 最近操作记录 -->
        <div class="card">
          <h2>🕑 Recent Log</h2>
          <table id="recentTable"><thead><tr><th>Date</th><th>Name</th><th>Qty</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- ② Badge Library -->
    <section id="tabLibrary" class="tab-content">
      <div class="card">
        <h2>📚 Badge Library</h2><p>Click a badge number to view details.</p>
        <div id="badgeGrid"></div><div id="badgeDesc" style="margin-top:1rem;">Select a badge...</div>
      </div>
    </section>

    <!-- ③ Fragment -->
    <section id="tabFragment" class="tab-content">
      <div class="card">
        <h2>✨ Fragment Tracker</h2>
        <p>Fragments: <strong id="fragmentCount">0</strong></p>
        <div class="progress-wrap" style="height:16px;"><div id="fragmentBar" class="progress-inner"></div></div>

        <h3 style="margin-top:1rem;">Log Fragment Change</h3>
        <form id="fragForm" style="display:flex;gap:0.4rem;flex-wrap:wrap;margin-bottom:0.6rem;">
          <input type="date" id="fDate" required>
          <select id="fType"><option value="add">Add</option><option value="use">Use</option></select>
          <input type="number" id="fQty" placeholder="Qty" min="1" required style="width:70px;">
          <input type="text"  id="fReason" placeholder="Reason" required>
          <button type="submit">Log</button>
        </form>
        <div style="display:flex;gap:0.6rem;margin-bottom:0.6rem;">
          <button id="fragExportBtn">Export CSV</button>
          <button id="fragRedeemBtn">Redeem 10 ↠ Badge</button>
        </div>

        <div class="frag-log"><table id="fragTable"><thead><tr><th>Date</th><th>Δ</th><th>Qty</th><th>Total</th><th>Reason</th></tr></thead><tbody></tbody></table></div>
      </div>
    </section>

    <!-- ④ Achievement Wall -->
    <section id="tabAchievement" class="tab-content">
      <div class="card">
        <h2>🏆 Achievement Wall</h2>
        <ul id="wallList" style="list-style:inside;"></ul>
        <p style="margin-top:1rem;"><a href="shop.html">🛒 Open Badge Shop (Coming Soon)</a></p>
      </div>
    </section>
  </main>

  <!-- ========= Script ========= -->
  <script>
    /* 粒子 */
    particlesJS("particles-js",{particles:{number:{value:55,density:{enable:true,value_area:900}},
      color:{value:"#b38b14"},shape:{type:"star"},opacity:{value:0.18,random:true},
      size:{value:7,random:true},line_linked:{enable:false},move:{enable:true,speed:1.2}},
      interactivity:{detect_on:"canvas",events:{onhover:{enable:true,mode:"repulse"}}}});

    /* 日期 & BoomBoom 文字 */
    document.getElementById('todayInfo').textContent=new Date().toDateString();
    const boomLines=["✨ A new badge today keeps the dullness away!","🌟 Every shard you collect tells a tale of effort!",
      "🪄 Hooray! Another magical moment to log your victory!","📜 Badges aren't just awards—they're wizard legacy!",
      "🎩 Polish your wand—achievements await!","🦉 BoomBoom believes in every sparkle you make!","🎖️ One step today is a golden badge tomorrow!",
      "💫 Log a badge, write Hogwarts history!","🪙 More badges, brighter wizard wall!","🔥 Don't stop—BoomBoom watches with pride!"];
    const boomTarget=document.getElementById('boomBoomLine');let j=0,msg=boomLines[Math.floor(Math.random()*boomLines.length)];
    (function typer(){if(j<msg.length){boomTarget.textContent+=msg.charAt(j++);setTimeout(typer,40);}})();

    /* Tabs */
    const tabs={btnHome:'tabHome',btnLibrary:'tabLibrary',btnFragment:'tabFragment',btnAchievement:'tabAchievement'};
    Object.keys(tabs).forEach(id=>{
      document.getElementById(id).addEventListener('click',e=>{
        /* 按钮高亮 */
        document.querySelectorAll('.backend-nav button').forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        /* 内容切换 */
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.getElementById(tabs[id]).classList.add('active');
      });
    });

    /* Badge 数据逻辑 */
    let badgeData=[];
    const badgeTableBody=document.querySelector('#badgeTable tbody');
    const recentBody      =document.querySelector('#recentTable tbody');
    const statTotalEl     =document.getElementById('statTotal');
    const statTypesEl     =document.getElementById('statTypes');
    const progressBar     =document.getElementById('badgeProgress');
    const statRankEl      =document.getElementById('statRank');
    const reminderList    =document.getElementById('reminderList');
    const wallList        =document.getElementById('wallList');

    function updateStats(){
      const total=badgeData.reduce((s,b)=>s+Number(b.qty),0);
      const types=[...new Set(badgeData.map(b=>b.name))].length;
      statTotalEl.textContent=total;
      statTypesEl.textContent=types;
      progressBar.style.width=Math.min(100,types/20*100)+'%';
      statRankEl.textContent=total>=30?'Archmage':total>=10?'Wizard':'Apprentice';

      /* Reminder */
      reminderList.innerHTML='';
      if(20-types===1) reminderList.innerHTML+='<li>🎉 还差 <strong>1</strong> 种徽章就集齐全部啦！</li>';
      const need=total<10?10-total:total<30?30-total:0;
      if(need>0) reminderList.innerHTML+=`<li>✨ 再获得 <strong>${need}</strong> 枚即可晋级！</li>`;

      /* 成就墙 */
      wallList.innerHTML='';
      badgeData.forEach(b=>{
        if(!wallList.querySelector(`[data-b="${b.name}"]`))
          wallList.insertAdjacentHTML('beforeend',`<li data-b="${b.name}">🏅 ${b.name} unlocked!</li>`);
      });
    }
    function renderBadgeTables(){
      badgeTableBody.innerHTML='';badgeData.forEach(r=>{
        badgeTableBody.insertAdjacentHTML('beforeend',
          `<tr><td>${r.date}</td><td>${r.name}</td><td>${r.reason}</td><td>${r.qty}</td><td>${r.total}</td></tr>`);});
      recentBody.innerHTML='';
      badgeData.slice(-5).reverse().forEach(r=>{
        recentBody.insertAdjacentHTML('beforeend',
          `<tr><td>${r.date}</td><td>${r.name}</td><td>${r.qty}</td></tr>`);});
      updateStats();
    }
    document.getElementById('badgeForm').addEventListener('submit',e=>{
      e.preventDefault();
      const row={date:document.getElementById('bDate').value,
                 name:document.getElementById('bName').value.trim(),
                 reason:document.getElementById('bReason').value.trim(),
                 qty:Number(document.getElementById('bQty').value),
                 total:Number(document.getElementById('bTotal').value)};
      badgeData.push(row);e.target.reset();renderBadgeTables();
    });
    document.getElementById('exportCsvBtn').addEventListener('click',()=>{
      if(!badgeData.length){alert('No data');return;}
      let csv='Date,Badge Name,Reason,Qty,Total\n';badgeData.forEach(r=>csv+=`"${r.date}","${r.name}","${r.reason}",${r.qty},${r.total}\n`);
      const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));const a=document.createElement('a');
      a.href=url;a.download=`badge_log_${new Date().toISOString().split('T')[0]}.csv`;a.click();URL.revokeObjectURL(url);
    });

    /* Badge Library */
    const badgeGrid=document.getElementById('badgeGrid');
    const badgeDesc=document.getElementById('badgeDesc');
    for(let k=1;k<=20;k++){
      const num=String(k).padStart(2,'0');
      const d=document.createElement('div');d.className='badge-item';d.textContent=num;
      d.onclick=()=>badgeDesc.innerHTML=`<strong>Badge ${num}</strong><br>Description: ...<br>Condition: ---`;
      badgeGrid.appendChild(d);
    }

    /* Fragment 模块 */
    let fragmentData=[],fragCount=0;
    const fragSpan=document.getElementById('fragmentCount');
    const fragBar =document.getElementById('fragmentBar');
    const fragBody=document.querySelector('#fragTable tbody');
    function updateFragmentDisplay(){fragSpan.textContent=fragCount;fragBar.style.width=Math.min(100,fragCount)+'%';}
    function renderFragTable(){
      fragBody.innerHTML='';fragmentData.forEach(r=>{
        fragBody.insertAdjacentHTML('beforeend',
          `<tr><td>${r.date}</td><td>${r.delta}</td><td>${r.qty}</td><td>${r.total}</td><td>${r.reason}</td></tr>`);});
      updateFragmentDisplay();
    }
    document.getElementById('fragForm').addEventListener('submit',e=>{
      e.preventDefault();
      const qty=Number(document.getElementById('fQty').value);
      const type=document.getElementById('fType').value;
      const delta=type==='add'?`+${qty}`:`-${qty}`;fragCount+=type==='add'?qty:-qty;
      fragmentData.push({date:document.getElementById('fDate').value,delta,qty,total:fragCount,reason:document.getElementById('fReason').value.trim()});
      e.target.reset();renderFragTable();
    });
    document.getElementById('fragExportBtn').addEventListener('click',()=>{
      if(!fragmentData.length){alert('No data');return;}
      let csv='Date,Δ,Qty,Total,Reason\n';fragmentData.forEach(r=>csv+=`"${r.date}","${r.delta}",${r.qty},${r.total},"${r.reason}"\n`);
      const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));const a=document.createElement('a');
      a.href=url;a.download=`fragment_log_${new Date().toISOString().split('T')[0]}.csv`;a.click();URL.revokeObjectURL(url);
    });
    document.getElementById('fragRedeemBtn').addEventListener('click',()=>{
      if(fragCount<10){alert('Not enough fragments!');return;}
      fragCount-=10;const today=new Date().toISOString().split('T')[0];
      fragmentData.push({date:today,delta:'-10',qty:10,total:fragCount,reason:'Redeem 1 Badge'});renderFragTable();
      alert('Redeemed 1 badge! Don\'t forget to log it in Badge Log.');
    });

    /* 初始化 */
    updateStats();updateFragmentDisplay();
  </script>
</body>
</html>
